<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一些关于技术的碎语"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>redis Stream（消息队列） | 微言术语</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">redis Stream（消息队列）</h1><a id="logo" href="/.">微言术语</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">redis Stream（消息队列）</h1><div class="post-meta"><a href="/2020/10/16/redis-stream/#comments" class="comment-count"></a><p><span class="date">Oct 16, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>Redis Stream 是 Redis 5.0 版本新增加的数据结构, 主要用于构建消息队列（MQ，Message Queue）。</p>
<h3 id="一、入门"><a href="#一、入门" class="headerlink" title="一、入门"></a>一、入门</h3><p>在旧版的Redis中，可以通过发布订阅 (pub/sub) 实现消息队列的功能。但是，通过发布订阅功能构建的消息队列无法持久化数据，如果遇到宕机之类的情况消息就会被丢弃。而 Redis Stream 提供了消息的持久化和主备复制功能，可以让任何客户端访问任何时刻的数据，并且能记住每一个客户端的访问位置，还能保证消息不丢失。</p>
<p><strong><em>消费者组</em></strong></p>
<p>消费者组最早是由名为Kafka（TM）的流行消息系统引入的。Redis用完全不同的术语重新实现了一个相似的概念，但目标是相同的：允许一组客户端相互配合来消费同一个Stream的不同部分的消息。</p>
<p>如果没有消费者组，仅使用XREAD，所有客户端都将获得所有到达流的条目。在消费者组中，给定的消费者（即从流中消费消息的客户端）必须使用唯一的消费者名称进行标识。该名称只是一个字符串。消费者组的保证之一是，给定的消费者只能看到发送给它的历史消息，因此每条消息只有一个所有者。</p>
<p>然而，还有一个特殊的特性叫做消息认领，其允许其他消费者在某些消费者无法恢复时认领消息。为了实现这样的语义，消费者组要求消费者使用XACK命令显式确认已成功处理的消息。</p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>Stream 是基于 RadixTree 数据结构实现的。基数树也叫基数特里树 radix trie 或压缩前缀树 compact prefix tree，是一种更节省空间的 Trie Tree 前缀树。若节点为唯一子节点则与其父节点合并。结构如下：<br><img src="/image/redis/redis-stream-struct.png" alt="Stream的数据结构"></p>
<p>每个 Stream 都有唯一的名称，它就是 Redis 的 key，在我们首次使用 xadd 指令追加消息时自动创建。</p>
<ul>
<li>Consumer Group ：消费组，使用 XGROUP CREATE 命令创建，一个消费组有多个消费者(Consumer)。</li>
<li>last_delivered_id ：游标，每个消费组会有个游标 last_delivered_id，任意一个消费者读取了消息都会使游标 last_delivered_id 往前移动。</li>
<li>pending_ids ：消费者(Consumer)的状态变量，作用是维护消费者的未确认的 id。 pending_ids 记录了当前已经被客户端读取的消息，但是还没有 ack (Acknowledge character：确认字符）</li>
</ul>
<h3 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a>二、使用</h3><p><strong><em>消息队列命令</em></strong></p>
<ul>
<li>XADD - 添加消息到末尾</li>
<li>XTRIM - 对流进行修剪，限制长度</li>
<li>XDEL - 删除消息</li>
<li>XLEN - 获取流包含的元素数量，即消息长度</li>
<li>XRANGE - 获取消息列表，会自动过滤已经删除的消息</li>
<li>XREVRANGE - 反向获取消息列表，ID 从大到小</li>
<li>XREAD - 以阻塞或非阻塞方式获取消息列表</li>
</ul>
<p><strong><em>消费者组命令</em></strong></p>
<p>消费者组：</p>
<ul>
<li>XGROUP CREATE - 创建消费者组</li>
<li>XGROUP SETID - 为消费者组设置新的最后递送消息ID</li>
<li>XGROUP DELCONSUMER - 删除消费者</li>
<li>XGROUP DESTROY - 删除消费者组</li>
</ul>
<p>消息信息：</p>
<ul>
<li>XINFO - 查看流和消费者组的相关信息；</li>
<li>XINFO GROUPS - 打印消费者组的信息；</li>
<li>XINFO STREAM - 打印流信息</li>
</ul>
<p>消费处理流程：</p>
<ul>
<li>XREADGROUP GROUP - 读取消费者组中的消息</li>
<li>XPENDING - 显示待处理消息的相关信息</li>
<li>XCLAIM - 转移消息的归属权</li>
<li>XACK - 将消息标记为”已处理”</li>
</ul>
<h4 id="消息队列命令"><a href="#消息队列命令" class="headerlink" title="消息队列命令"></a>消息队列命令</h4><ol>
<li><p>XADD<br>用于向队列添加消息，如果指定队列不存在，则创建一个队列。语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XADD key ID field value [field value ...] </span><br><span class="line">	key：队列名称</span><br><span class="line">	ID：消息id，使用`*`表示由系统自动生成</span><br><span class="line">	field value：记录</span><br></pre></td></tr></table></figure>
</li>
<li><p>XLEN<br>获取消息长度。语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XLEN key</span><br></pre></td></tr></table></figure>
</li>
<li><p>XTRIM<br>使用 XTRIM 对流进行修剪，限制长度， 语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XTRIM key MAXLEN [~] count</span><br><span class="line">key ：队列名称</span><br><span class="line">MAXLEN ：长度</span><br><span class="line">[~]: 可选项，表示修剪后数量不少于count个即可</span><br><span class="line">count ：数量</span><br></pre></td></tr></table></figure>
</li>
<li><p>XDEL<br>从指定流中移除指定的条目，并返回成功删除的条目的数量，在传递的ID不存在的情况下， 返回的数量可能与传递的ID数量不同。语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">XDEL key ID [ID ...]</span><br><span class="line"></span><br><span class="line">Redis流以一种使其内存高效的方式表示：使用基数树来索引包含线性数十个Stream条目的宏节点。当从Stream中删除一个条目的时候，条目并没有真正被驱逐，只是被标记为删除。</span><br></pre></td></tr></table></figure>
</li>
<li><p>XRANGE<br>此命令返回流中满足给定ID范围的条目。范围由最小和最大ID指定。所有ID在指定的两个ID之间或与其中一个ID相等（闭合区间）的条目将会被返回。语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XRANGE key start end [COUNT count]</span><br><span class="line">XRANGE命令有许多用途：</span><br><span class="line">	返回特定时间范围的项目。这是可能的，因为流的ID与时间相关。</span><br><span class="line">	增量迭代流，每次迭代只返回几个项目。但它在语义上比SCAN函数族强大很多。</span><br><span class="line">	从流中获取单个条目，提供要获取两次的条目的ID：作为查询间隔的开始和结束。</span><br><span class="line"></span><br><span class="line">该命令还有一个倒序命令，以相反的顺序返回项目，叫做 XREVRANGE，除了返回顺序相反以外，它们是完全相同的。特殊ID-和+分别表示流中可能的最小ID和最大ID</span><br></pre></td></tr></table></figure>
</li>
<li><p>XREAD</p>
</li>
</ol>
<p>从一个或者多个流中读取数据，仅返回ID大于调用者报告的最后接收ID的条目。此命令有一个阻塞选项，用于等待可用的项目，类似于BRPOP或者BZPOPMIN等等。使用 XREAD 以阻塞或非阻塞方式获取消息列表 ，语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br><span class="line">	count ：数量</span><br><span class="line">	milliseconds ：可选，阻塞毫秒数，没有设置就是非阻塞模式</span><br><span class="line">	key ：队列名</span><br><span class="line">	id ：消息 ID</span><br></pre></td></tr></table></figure>

<p>该命令返回一个结果数组：返回数组的每个元素都是一个由两个元素组成的数组（键名和为该键报告的条目）。报告的条目是完整的流条目，具有ID以及所有字段和值的列表。返回的条目及其字段和值的顺序与使用XADD添加它们的顺序完全一致。</p>
<p>当使用BLOCK时，超时时将返回一个空回复（nil）。</p>
<p><strong><em>实例</em></strong></p>
<ol>
<li>消息ID的序列化生成<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xadd ms * name mk age 23</span><br><span class="line">&quot;1602855570665-0&quot;</span><br><span class="line">127.0.0.1:6379&gt; xadd ms * name bb age 2</span><br><span class="line">&quot;1602855577557-0&quot;</span><br><span class="line">127.0.0.1:6379&gt; xadd ms * name ct age 43</span><br><span class="line">&quot;1602855589097-0&quot;</span><br><span class="line">127.0.0.1:6379&gt; xadd ms * name yy age 88</span><br><span class="line">&quot;1602855597238-0&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>XADD生成的 （1602763951440-0），就是Redis生成的消息ID，由两部分组成:时间戳-序号。时间戳是毫秒级单位，是生成消息的Redis服务器时间，它是个64位整型（int64）。序号是在这个毫秒时间点内的消息序号，它也是个64位整型。</p>
<ol start="2">
<li>消息遍历</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; XRANGE mystream - +</span><br><span class="line">1) 1) &quot;1602763789606-0&quot;</span><br><span class="line">   2) 1) &quot;name&quot;</span><br><span class="line">      2) &quot;pt&quot;</span><br><span class="line">      3) &quot;age&quot;</span><br><span class="line">      4) &quot;12&quot;</span><br><span class="line">      5) &quot;sex&quot;</span><br><span class="line">      6) &quot;boy&quot;</span><br><span class="line">2) 1) &quot;1602763898101-0&quot;</span><br><span class="line">   2) 1) &quot;name&quot;</span><br><span class="line">      2) &quot;marry&quot;</span><br><span class="line">      3) &quot;age&quot;</span><br><span class="line">      4) &quot;21&quot;</span><br><span class="line">      5) &quot;sex&quot;</span><br><span class="line">      6) &quot;girl&quot;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>消息的长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xlen ms</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>
</li>
<li><p>消息裁剪</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xtrim ms MAXLEN 1</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取消息</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># ID（0-0）后的消息，即消息队列中第一个消息</span><br><span class="line">127.0.0.1:6379&gt; xread count 1 streams ms 0-0</span><br><span class="line">1) 1) &quot;ms&quot;</span><br><span class="line">   2) 1) 1) &quot;1602855570665-0&quot;</span><br><span class="line">         2) 1) &quot;name&quot;</span><br><span class="line">            2) &quot;mk&quot;</span><br><span class="line">            3) &quot;age&quot;</span><br><span class="line">            4) &quot;23&quot;</span><br><span class="line">			</span><br><span class="line"># ID（1602855570665-0）下一个消息</span><br><span class="line">127.0.0.1:6379&gt; xread count 1 streams ms 1602855570665-0</span><br><span class="line">1) 1) &quot;ms&quot;</span><br><span class="line">   2) 1) 1) &quot;1602855577557-0&quot;</span><br><span class="line">         2) 1) &quot;name&quot;</span><br><span class="line">            2) &quot;bb&quot;</span><br><span class="line">            3) &quot;age&quot;</span><br><span class="line">            4) &quot;2&quot;</span><br><span class="line"></span><br><span class="line"># 阻塞消息</span><br><span class="line">127.0.0.1:6379&gt; xread block 1000 count 1 streams ms 0-0</span><br><span class="line">1) 1) &quot;ms&quot;</span><br><span class="line">   2) 1) 1) &quot;1602855570665-0&quot;</span><br><span class="line">         2) 1) &quot;name&quot;</span><br><span class="line">            2) &quot;mk&quot;</span><br><span class="line">            3) &quot;age&quot;</span><br><span class="line">            4) &quot;23&quot;</span><br><span class="line"></span><br><span class="line"># $符号用于获取最新的消息，应该仅在第一次调用XREAD时使用。后面的ID你应该使用前一次报告的项目中最后一项的ID，否则你将会丢失所有添加到这中间的条目。</span><br><span class="line">xread block 1000 count 1 streams ms $</span><br></pre></td></tr></table></figure>

<h4 id="消费者组命令"><a href="#消费者组命令" class="headerlink" title="消费者组命令"></a>消费者组命令</h4><ol>
<li><p>XGROUP<br>消费者组相关命令，语法格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 创建命令</span><br><span class="line">XGROUP [CREATE key groupname id-or-$]</span><br><span class="line"># 将消费者组的最后交付ID设置为其他内容</span><br><span class="line">XGROUP [SETID key groupname id-or-$]</span><br><span class="line"># 销毁消费者组</span><br><span class="line">XGROUP [DESTROY key groupname]</span><br><span class="line"># 移除指定的消费者</span><br><span class="line">XGROUP [DELCONSUMER key groupname consumername]</span><br></pre></td></tr></table></figure>
</li>
<li><p>XINFO<br>这是一个内省命令，用于检索关于流和关联的消费者组的不同的信息</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">XINFO [CONSUMERS key groupname] </span><br><span class="line">XINFO [GROUPS key] </span><br><span class="line">XINFO [STREAM key] </span><br><span class="line">XINFO [HELP]</span><br><span class="line"></span><br><span class="line">消费组中消费者列表</span><br><span class="line">XINFO CONSUMERS &lt;key&gt; &lt;group&gt;</span><br><span class="line"></span><br><span class="line">获得与流关联的所有消费者组的输出</span><br><span class="line">XINFO GROUPS &lt;key&gt;</span><br><span class="line"></span><br><span class="line">存储在特定键的流的一般信息</span><br><span class="line">XINFO STREAM &lt;key&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>XREADGROUP<br>XREADGROUP命令是XREAD命令的特殊版本，支持消费者组，用于消费者从消息队列获取信息。通过消费者组从流中获取数据，而不是确认这些数据，具有创建待处理条目的效果。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP groupname consumername [COUNT count] [BLOCK milliseconds] STREAMS key [key ...] ID [ID ...]</span><br><span class="line">	groupname：消费者组</span><br><span class="line">	consumername：消费者，在第一次使用时会自动的为消费者组添加消费者</span><br><span class="line">	COUNT：消息数量</span><br><span class="line">	BLOCK：显示定义，则是阻塞的；参数是毫秒</span><br><span class="line">	STREAMS key [key ...]：流名称</span><br><span class="line">	ID [ID ...]：消息ID</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>XPENDING</li>
</ol>
<p>显示待处理消息的相关信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XPENDING key groupname [start end count] [consumer]</span><br><span class="line">key：流名称</span><br><span class="line">groupname：消费者组</span><br><span class="line">[start end count]：消息范围，例如“- + 10”</span><br><span class="line">[consumer]：消费者名称</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>XCLAIM<br>将待处理消息的所有人转移.</li>
</ol>
<blockquote>
<p>请注意，消息只有在其空闲时间大于我们通过XCLAIM指定的空闲时间的时才会被认领。 因为作为一个副作用，XCLAIM也会重置消息的空闲时间（因为这是处理消息的一次新尝试）， 两个试图同时认领消息的消费者将永远不会成功：只有一个消费者能成功认领消息。 这避免了我们用微不足道的.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XCLAIM key group consumer min-idle-time ID [ID ...] [IDLE ms] [TIME ms-unix-time] [RETRYCOUNT count] [FORCE] [JUSTID]</span><br><span class="line">	IDLE &lt;ms&gt;: 设置消息的空闲时间</span><br><span class="line">	TIME &lt;ms-unix-time&gt;: 这个命令与IDLE相同，但它不是设置相对的毫秒数，而是将空闲时间设置为一个指定的Unix时间</span><br><span class="line">	RETRYCOUNT &lt;count&gt;: 将重试计数器设置为指定的值</span><br><span class="line">	FORCE: 在待处理条目列表（PEL）中创建待处理消息条目</span><br><span class="line">	JUSTID: 只返回成功认领的消息ID数组，不返回实际的消息。</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>XACK<br>会立即从待处理条目列表（PEL）中移除待处理条目，因为一旦消息被成功处理，消费者组就不再需要跟踪它并记住消息的当前所有者。<br>XACK命令用于从流的消费者组的待处理条目列表（简称PEL）中删除一条或多条消息。一旦消费者成功地处理完一条消息，它应该调用XACK，这样这个消息就不会被再次处理.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">XACK key group ID [ID ...]</span><br><span class="line">返回值:</span><br><span class="line">	integer-reply：</span><br><span class="line">	该命令返回成功确认的消息数。 某些消息ID可能不再是PEL的一部分（例如因为它们已经被确认）， 而且XACK不会把他们算到成功确认的数量中。</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong><em>实例</em></strong></p>
<ol>
<li>消息的分组消费(创建组)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xgroup create ms mg1 $</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><code>$</code>这表示流中最后一项的ID.</p>
<p>1.2 重新设置流ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xgroup setid ms mg1 0</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>1.3 销毁消费者组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xgroup destroy ms mg1</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>获取流、消费者组、消费者的信息（消息队列监控）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xinfo stream ms</span><br><span class="line"> 1) &quot;length&quot;</span><br><span class="line"> 2) (integer) 4</span><br><span class="line"> 3) &quot;radix-tree-keys&quot;</span><br><span class="line"> 4) (integer) 1</span><br><span class="line"> 5) &quot;radix-tree-nodes&quot;</span><br><span class="line"> 6) (integer) 2</span><br><span class="line"> 7) &quot;last-generated-id&quot;</span><br><span class="line"> 8) &quot;1602855597238-0&quot;</span><br><span class="line"> 9) &quot;groups&quot;</span><br><span class="line">10) (integer) 1</span><br><span class="line">11) &quot;first-entry&quot;</span><br><span class="line">12) 1) &quot;1602855570665-0&quot;</span><br><span class="line">    2) 1) &quot;name&quot;</span><br><span class="line">       2) &quot;mk&quot;</span><br><span class="line">       3) &quot;age&quot;</span><br><span class="line">       4) &quot;23&quot;</span><br><span class="line">13) &quot;last-entry&quot;</span><br><span class="line">14) 1) &quot;1602855597238-0&quot;</span><br><span class="line">    2) 1) &quot;name&quot;</span><br><span class="line">       2) &quot;yy&quot;</span><br><span class="line">       3) &quot;age&quot;</span><br><span class="line">       4) &quot;88&quot;</span><br><span class="line">127.0.0.1:6379&gt; xinfo groups ms</span><br><span class="line">1) 1) &quot;name&quot;</span><br><span class="line">   2) &quot;mg1&quot;</span><br><span class="line">   3) &quot;consumers&quot;</span><br><span class="line">   4) (integer) 0</span><br><span class="line">   5) &quot;pending&quot;</span><br><span class="line">   6) (integer) 0</span><br><span class="line">   7) &quot;last-delivered-id&quot;</span><br><span class="line">   8) &quot;0-0&quot;</span><br><span class="line">127.0.0.1:6379&gt; xinfo consumers ms mg1</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过消费者组从流读取消息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xreadgroup group  mg1 com1  count 2 streams ms &gt;</span><br><span class="line">1) 1) &quot;ms&quot;</span><br><span class="line">   2) 1) 1) &quot;1602855570665-0&quot;</span><br><span class="line">         2) 1) &quot;name&quot;</span><br><span class="line">            2) &quot;mk&quot;</span><br><span class="line">            3) &quot;age&quot;</span><br><span class="line">            4) &quot;23&quot;</span><br><span class="line">      2) 1) &quot;1602855577557-0&quot;</span><br><span class="line">         2) 1) &quot;name&quot;</span><br><span class="line">            2) &quot;bb&quot;</span><br><span class="line">            3) &quot;age&quot;</span><br><span class="line">            4) &quot;2&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示待处理消息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xpending ms mg1 - + 10 com1</span><br><span class="line">1) 1) &quot;1602855570665-0&quot;</span><br><span class="line">   2) &quot;com1&quot;</span><br><span class="line">   3) (integer) 255408</span><br><span class="line">   4) (integer) 1</span><br><span class="line">2) 1) &quot;1602855577557-0&quot;</span><br><span class="line">   2) &quot;com1&quot;</span><br><span class="line">   3) (integer) 255408</span><br><span class="line">   4) (integer) 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>未完成消息的处理(转移所有者)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xclaim ms mg1 com2 30 1602855570665-0</span><br><span class="line">1) 1) &quot;1602855570665-0&quot;</span><br><span class="line">   2) 1) &quot;name&quot;</span><br><span class="line">      2) &quot;mk&quot;</span><br><span class="line">      3) &quot;age&quot;</span><br><span class="line">      4) &quot;23&quot;</span><br><span class="line">127.0.0.1:6379&gt; xpending ms mg1 - + 10 com1</span><br><span class="line">1) 1) &quot;1602855577557-0&quot;</span><br><span class="line">   2) &quot;com1&quot;</span><br><span class="line">   3) (integer) 801202</span><br><span class="line">   4) (integer) 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>确认消息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; xack ms mg1 1602855577557-0</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong><em>死信问题</em></strong></p>
<p>死信，对应的单词为“Dead Letter”。如果某个消息，不能被消费者处理，也就是不能被XACK，这是要长时间处于Pending列表中，即使被反复的转移给各个消费者也是如此。此时该消息的delivery counter就会累加（pending）,当到临界时，使用<code>XDEL</code>删除即可。</p>
<p>但是，并没有删除Pending中的消息因此你查看Pending，消息还会在。可以执行XACK标识其处理完毕！</p>
</div><div class="post-copyright"><blockquote><p>原文作者: 古城烟雨</p><p>原文链接: <a href="http://zws6672.top/2020/10/16/redis-stream/">http://zws6672.top/2020/10/16/redis-stream/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/Redis/">Redis</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/10/17/redis-geo/" class="pre">redis-geo</a><a href="/2020/10/15/redis-bloom/" class="next">redis 布隆过滤器</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、入门"><span class="toc-text">一、入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据结构"><span class="toc-text">数据结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、使用"><span class="toc-text">二、使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#消息队列命令"><span class="toc-text">消息队列命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#消费者组命令"><span class="toc-text">消费者组命令</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/05/15/fmi-daccosim/">基于FMI标准的仿真软件————Daccosim</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/15/vue_add_method/">vue_add_method</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/15/test/">test</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/15/springboot-1/">springboot（一）入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/26/jdk-bytecodeEngine/">虚拟机字节码执行引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/15/jdk-cload/">虚拟机类加载机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/14/jdk-classesFileStruct/">深入理解Java虚拟机——类文件结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/04/springboot-aop/">SpringBoot 使用 AOP（面向切面编程）</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/30/mysql-lock/">mysql 引擎的行锁与表锁</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/29/design-structure-eg/">结构型模式——实例</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/devops/" style="font-size: 15px;">devops</a> <a href="/tags/neo4j/" style="font-size: 15px;">neo4j</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/ms/" style="font-size: 15px;">ms</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/javaweb/" style="font-size: 15px;">javaweb</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/fmi/" style="font-size: 15px;">fmi</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/nk/" style="font-size: 15px;">nk</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://juejin.im/" title="掘金" target="_blank">掘金</a><ul></ul><a href="https://www.cnblogs.com/" title="博客园" target="_blank">博客园</a><ul></ul><a href="https://www.infoq.cn/" title="info" target="_blank">info</a><ul></ul><a href="https://www.ibm.com/" title="ibm" target="_blank">ibm</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">古城烟雨.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>