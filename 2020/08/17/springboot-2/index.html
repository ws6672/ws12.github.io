<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一些关于技术的碎语"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>springboot（二）配置与启动 | 微言术语</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">springboot（二）配置与启动</h1><a id="logo" href="/.">微言术语</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">springboot（二）配置与启动</h1><div class="post-meta"><a href="/2020/08/17/springboot-2/#comments" class="comment-count"></a><p><span class="date">Aug 17, 2020</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h3 id="1-基本配置"><a href="#1-基本配置" class="headerlink" title="1. 基本配置"></a>1. 基本配置</h3><h5 id="1-1-Banner"><a href="#1-1-Banner" class="headerlink" title="1.1 Banner"></a>1.1 Banner</h5><p>Banner是指横幅之类的，有趣的是每次<code>SpringBoot</code>都会输出以下的图案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &apos;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br></pre></td></tr></table></figure>

<p>而我们自定义这个图案。</p>
<p><strong><em>语法</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">banner.txt配置</span><br><span class="line">　　$&#123;AnsiColor.BRIGHT_RED&#125;：设置控制台中输出内容的颜色</span><br><span class="line">　　$&#123;application.version&#125;：用来获取MANIFEST.MF文件中的版本号</span><br><span class="line">　　$&#123;application.formatted-version&#125;：格式化后的$&#123;application.version&#125;版本信息</span><br><span class="line">　　$&#123;spring-boot.version&#125;：Spring Boot的版本号</span><br><span class="line">　　$&#123;spring-boot.formatted-version&#125;：格式化后的$&#123;spring-boot.version&#125;版本信息</span><br></pre></td></tr></table></figure>

<p><strong><em>自定义banner</em></strong></p>
<ol>
<li><p>编写文件<code>banner.txt</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;</span><br><span class="line">////////////////////////////////////////////////////////////////////</span><br><span class="line">//                          _ooOoo_                               //</span><br><span class="line">//                         o8888888o                              //</span><br><span class="line">//                         88&quot; . &quot;88                              //</span><br><span class="line">//                         (| ^_^ |)                              //</span><br><span class="line">//                         O\  =  /O                              //</span><br><span class="line">//                      ____/`---&apos;\____                           //</span><br><span class="line">//                    .&apos;  \\|     |//  `.                         //</span><br><span class="line">//                   /  \\|||  :  |||//  \                        //</span><br><span class="line">//                  /  _||||| -:- |||||-  \                       //</span><br><span class="line">//                  |   | \\\  -  /// |   |                       //</span><br><span class="line">//                  | \_|  &apos;&apos;\---/&apos;&apos;  |   |                       //</span><br><span class="line">//                  \  .-\__  `-`  ___/-. /                       //</span><br><span class="line">//                ___`. .&apos;  /--.--\  `. . ___                     //</span><br><span class="line">//              .&quot;&quot; &apos;&lt;  `.___\_&lt;|&gt;_/___.&apos;  &gt;&apos;&quot;&quot;.                  //</span><br><span class="line">//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //</span><br><span class="line">//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //</span><br><span class="line">//      ========`-.____`-.___\_____/___.-`____.-&apos;========         //</span><br><span class="line">//                           `=---=&apos;                              //</span><br><span class="line">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //</span><br><span class="line">//            佛祖保佑       永不宕机      永无BUG                //</span><br><span class="line">////////////////////////////////////////////////////////////////////</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义<code>application.yml</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring: </span><br><span class="line">  banner:</span><br><span class="line">    charset: UTF-8</span><br><span class="line">    location: banner.txt</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong><em>关闭banner</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class ExampleApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication app = new SpringApplication(ExampleApplication.class);</span><br><span class="line">        app.setBannerMode(Banner.Mode.OFF);</span><br><span class="line">        app.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-全局配置文件"><a href="#1-2-全局配置文件" class="headerlink" title="1.2 全局配置文件"></a>1.2 全局配置文件</h5><p>SpringBoot使用的全局配置文件为：</p>
<ul>
<li>application.properties</li>
<li>application.yml</li>
</ul>
<p>配置一个即可，yml格式比properties格式的简洁一些。配置文件路径是<code>\src\main\resources</code>。</p>
<p><strong><em>properties 实例</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.port=8888</span><br><span class="line">server.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br><span class="line">server.datasource.url=mysql://localhost:3306/toolweb?serverTimezone=UTC&amp;useSSL=false</span><br><span class="line">server.datasource.username=root</span><br><span class="line">server.datasource.password=root</span><br></pre></td></tr></table></figure>

<p><strong><em>yml 实例</em></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8888</span><br><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    url: jdbc:mysql://localhost:3306/toolweb?serverTimezone=UTC&amp;useSSL=false</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br></pre></td></tr></table></figure>

<p><strong><em>使用XML文件</em></strong></p>
<p>XML文件配置如下：<code>@ImportResource({&quot;classpath:some-context.xml&quot;,&quot;classpath:another-context.xml&quot;})</code></p>
<h3 id="2-外部配置"><a href="#2-外部配置" class="headerlink" title="2.  外部配置"></a>2.  外部配置</h3><p>外部配置包括命令行参数配置、常规属性配置以及类型安全的配置。</p>
<h5 id="2-1-命令行参数配置"><a href="#2-1-命令行参数配置" class="headerlink" title="2.1 命令行参数配置"></a>2.1 命令行参数配置</h5><p>默认情况下，SpringApplication会将所有命令行配置参数（以’–’开头，比如<code>--server.port=9000</code>）转化成一个property，并将其添加到Spring Environment中，命令行属性总是优先于其他属性源。</p>
<p>阻止属性添加到环境：<code>SpringApplication.setAddCommandLineProperties(false)</code></p>
<p>springboot项目可以基于jar包运行，打开jar的程序可以通过下面命令行运行：<code>java -jar xxx.jar</code></p>
<p>修改tomcat端口：<code>java -jar xxx.jar --server.port=9090</code></p>
<h5 id="2-2-常规属性配置"><a href="#2-2-常规属性配置" class="headerlink" title="2.2 常规属性配置"></a>2.2 常规属性配置</h5><p><strong>*application.properties *</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">book.author=wangyunfei</span><br><span class="line">book.name=spring boot</span><br></pre></td></tr></table></figure>

<p><strong><em>入口类</em></strong><br>通过<code>@Value</code>注入属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;book.author&#125;&quot;)</span><br><span class="line">    private String bookAuthor;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;book.name&#125;&quot;)</span><br><span class="line">    private String bookName;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/&quot;)</span><br><span class="line">    String index()&#123;</span><br><span class="line">        return &quot;book name is :&quot; + bookName + &quot; and book author is: &quot; + bookAuthor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-类型安全的配置"><a href="#2-3-类型安全的配置" class="headerlink" title="2.3 类型安全的配置"></a>2.3 类型安全的配置</h5><p>通过<code>@ConfigurationProperties</code>将<code>properties</code>属性和一个<code>Bean</code>及其相关属性关联、从而实现类型安全的配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">author.name=wyf</span><br><span class="line">author.age=32</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@ConfigurationProperties(prefix = &quot;author&quot;)</span><br><span class="line">public class Author &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">@SpringBootApplication</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;book.author&#125;&quot;)</span><br><span class="line">    private String bookAuthor;</span><br><span class="line"></span><br><span class="line">    @Value(&quot;$&#123;book.name&#125;&quot;)</span><br><span class="line">    private String bookName;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    Author author;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-其它相关配置"><a href="#3-其它相关配置" class="headerlink" title="3. 其它相关配置"></a>3. 其它相关配置</h3><p><strong><em>配置的优先级</em></strong></p>
<ol>
<li>Spring Boot 所提供的配置优先级顺序比较复杂。按照优先级从高到低的顺序，具体的列表如下所示：</li>
</ol>
<ul>
<li>命令行参数（优先级最高，有利于实际环境调整参数）</li>
<li>通过 System.getProperties() 获取的 Java 系统参数。</li>
<li>操作系统环境变量。</li>
<li>从 java:comp/env 得到的 JNDI 属性。</li>
<li>通过 RandomValuePropertySource 生成的<code>“random.*”</code>属性。</li>
<li>应用 Jar 文件之外的属性文件。(通过spring.config.location参数)</li>
<li>应用 Jar 文件内部的属性文件。</li>
<li>在应用配置 Java 类（包含“@Configuration”注解的 Java 类）中通过“@PropertySource”注解声明的属性文件。</li>
<li>通过“SpringApplication.setDefaultProperties”声明的默认属性。</li>
</ul>
<ol start="2">
<li><p>在同一目录下，properties配置优先级 &gt; YAML配置优先级、</p>
</li>
<li><p>SpringBoot配置文件可以放置在多种路径下，不同路径下的配置优先级有所不同。<br>可放置目录(优先级从高到低)，高优先级的配置会覆盖低优先级的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">file:./config/ (当前项目路径config目录下);</span><br><span class="line">file:./ (当前项目路径下);</span><br><span class="line">classpath:/config/ (类路径config目录下);</span><br><span class="line">classpath:/ (类路径config下).</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="3-1-profile"><a href="#3-1-profile" class="headerlink" title="3.1 profile"></a>3.1 profile</h5><p>Profile主要用于区分不同的环境。</p>
<p><strong><em>@Profile</em></strong><br>在某个类、或者方法上添加<code>@Profile</code>注解，指定具体的profile环境标签，那么只有在该profile处于active的情况下该类、方法才会被加载、执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Profile(&#123;&quot;dev&quot;,&quot;test&quot;&#125;)</span><br><span class="line">public class Xxx&#123;</span><br><span class="line">    </span><br><span class="line">    @Profile(&#123;&quot;dev&quot;&#125;)</span><br><span class="line">    @Bean</span><br><span class="line">    public Xxx xxx()&#123;</span><br><span class="line">        return new Xxx();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>多环境配置</em></strong></p>
<p>使用properties配置文件实现多环境配置，可以通过添加多个application-{profile}.properties来实现。比如：<br><code>application-dev.properties,application-test.properties</code></p>
<p>使用YAML实现多环境配置要简单的多，只需要一个文件即可，application.yml.例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">spring:</span><br><span class="line">  profiles:</span><br><span class="line">	active: test #激活</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line">spring:</span><br><span class="line">  profiles: dev #生产环境</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">server:</span><br><span class="line">  port: 8084</span><br><span class="line">spring:</span><br><span class="line">  profiles: test  #测试环境</span><br></pre></td></tr></table></figure>

<p>我们也可以通过命令行来激活相关配置，而且优先级更高.例如：<code>--spring.profiles.active=dev</code></p>
<h5 id="3-2-日志"><a href="#3-2-日志" class="headerlink" title="3.2 日志"></a>3.2 日志</h5><blockquote>
<p>为了保证服务的高可用，发现问题一定要即使，解决问题一定要迅速，所以生产环境一旦出现问题，预警系统就会通过邮件、短信甚至电话的方式实施多维轰炸模式，确保相关负责人不错过每一个可能的bug。</p>
</blockquote>
<p>Spring Boot默认使用LogBack日志系统，如果不需要更改为其他日志系统如Log4j2等，则无需多余的配置，LogBack默认将日志打印到控制台上。新建的Spring Boot项目一般都会引用<code>spring-boot-starter</code>或者<code>spring-boot-starter-web</code>，这两个依赖中已经包含了对于<code>spring-boot-starter-logging</code>的依赖，所以，无需额外添加依赖。</p>
<blockquote>
<p>Spring Boot默认使用LogBack日志系统，默认的日志级别为INFO。</p>
</blockquote>
<p><strong><em>存储日志</em></strong><br>默认文件名为spring.log，默认路径在当前项目下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logging:</span><br><span class="line">  file:</span><br><span class="line">    name: springboot-example.log # 配置日志文件名</span><br></pre></td></tr></table></figure>

<p><strong><em>日志级别</em></strong></p>
<p>日志级别总共有TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL ，且级别是逐渐提供，如果日志级别设置为INFO，则意味TRACE和DEBUG级别的日志都看不到。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 配置级别为 warn，INFO级别以下的信息无法查看，只显示（WARN、ERROR、FATAL ）级别的信息</span><br><span class="line">logging:</span><br><span class="line">  file:</span><br><span class="line">    name: springboot-example.log</span><br><span class="line">  level:</span><br><span class="line">    root: warn</span><br></pre></td></tr></table></figure>

<p><strong><em>定义日志格式</em></strong></p>
<p>springboot支持自定义日志输出格式，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 定制日志输出格式</span><br><span class="line">logging.pattern.console=%d&#123;yyyy/MM/dd-HH:mm:ss&#125; [%thread] %-5level %logger- %msg%n  </span><br><span class="line">logging.pattern.file=%d&#123;yyyy/MM/dd-HH:mm&#125; [%thread] %-5level %logger- %msg%n</span><br></pre></td></tr></table></figure>

<p>符号含义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%d&#123;HH:mm:ss.SSS&#125;——日志输出时间</span><br><span class="line">%thread——输出日志的进程名字，这在Web应用以及异步任务处理中很有用</span><br><span class="line">%-5level——日志级别，并且使用5个字符靠左对齐</span><br><span class="line">%logger- ——日志输出者的名字</span><br><span class="line">%msg——日志消息</span><br><span class="line">%n——平台的换行符</span><br></pre></td></tr></table></figure>

<h3 id="4-核心注解"><a href="#4-核心注解" class="headerlink" title="4. 核心注解"></a>4. 核心注解</h3><h5 id="4-1-SpringBootApplication"><a href="#4-1-SpringBootApplication" class="headerlink" title="4.1 @SpringBootApplication"></a>4.1 @SpringBootApplication</h5><p>@SpringBootApplication是一个复合注解，源码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@SpringBootConfiguration</span><br><span class="line">@EnableAutoConfiguration</span><br><span class="line">@ComponentScan(</span><br><span class="line">    excludeFilters = &#123;@Filter(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;TypeExcludeFilter.class&#125;</span><br><span class="line">), @Filter(</span><br><span class="line">    type = FilterType.CUSTOM,</span><br><span class="line">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span><br><span class="line">)&#125;</span><br><span class="line">)</span><br><span class="line">public @interface SpringBootApplication &#123;</span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = EnableAutoConfiguration.class</span><br><span class="line">    )</span><br><span class="line">    Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = EnableAutoConfiguration.class</span><br><span class="line">    )</span><br><span class="line">    String[] excludeName() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = &quot;basePackages&quot;</span><br><span class="line">    )</span><br><span class="line">    String[] scanBasePackages() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = &quot;basePackageClasses&quot;</span><br><span class="line">    )</span><br><span class="line">    Class&lt;?&gt;[] scanBasePackageClasses() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = ComponentScan.class,</span><br><span class="line">        attribute = &quot;nameGenerator&quot;</span><br><span class="line">    )</span><br><span class="line">    Class&lt;? extends BeanNameGenerator&gt; nameGenerator() default BeanNameGenerator.class;</span><br><span class="line"></span><br><span class="line">    @AliasFor(</span><br><span class="line">        annotation = Configuration.class</span><br><span class="line">    )</span><br><span class="line">    boolean proxyBeanMethods() default true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到该注解中包含了以下三个重要注解:</p>
<ul>
<li><code>@SpringBootConfiguration</code><ul>
<li>继承自<code>@Configuration</code>，二者功能也一致，标注当前类是配置类，并会将当前类内声明的一个或多个以<code>@Bean</code>注解标记的方法的实例纳入到srping容器中，并且实例名就是方法名。</li>
<li>也就是说，定义了该注解的类中，可以通过在方法上定义<code>@Bean</code> 配置文件</li>
</ul>
</li>
<li><code>@EnableAutoConfiguration</code><ul>
<li>启用自动配置</li>
<li>根据添加的jar包来配置项目的默认配置</li>
</ul>
</li>
<li><code>@ComponentScan</code><ul>
<li>扫描组件, 类似于 Spring的配置 <code>&lt;context:component-scan&gt;</code></li>
<li>扫描当前包及其子包下被<code>@Component</code>，<code>@Controller</code>，<code>@Service</code>，<code>@Repository</code>注解标记的类并纳入到spring容器中进行管理</li>
</ul>
</li>
</ul>
<p><strong><em>关闭自动配置</em></strong><br>例如以下配置，会取消自动配置<code>DataSourceAutoConfiguration</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="4-2-Enable-系列注解"><a href="#4-2-Enable-系列注解" class="headerlink" title="4.2 @Enable* 系列注解"></a>4.2 @Enable* 系列注解</h5><blockquote>
<p><code>@enable*</code>是springboot中用来启用某一个功能特性的一类注解。其中包括我们常用的几个注解：<br>用于开启自动注入的注解<code>@EnableAutoConfiguration</code><br>开启异步方法的 注解<code>@EnableAsync</code><br>开启将配置文件中的属性以bean的方式注入到IOC容器的注解<code>@EnableConfigurationProperties</code></p>
</blockquote>
<p><strong><em>@EnableAutoConfiguration</em></strong></p>
<p>它的源码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">@Inherited</span><br><span class="line">@AutoConfigurationPackage</span><br><span class="line">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span><br><span class="line">public @interface EnableAutoConfiguration &#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = &quot;spring.boot.enableautoconfiguration&quot;;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] exclude() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() default &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 由Spring提供的，用来导入配置类的，在配置类中定义的Bean(@Bean)，可通过@Autowired注入到容器中，也就是可以被扫描到</span><br><span class="line">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Documented</span><br><span class="line">public @interface Import &#123;</span><br><span class="line">    Class&lt;?&gt;[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Import</code>用来导入一个或多个class，这些类会注入到spring容器中，或者配置类，配置类里面定义的bean都会被spring容器托管。通过<code>@Import</code>注入了<code>AutoConfigurationImportSelector</code>类。</p>
<h3 id="5-启动原理"><a href="#5-启动原理" class="headerlink" title="5. 启动原理"></a>5. 启动原理</h3><p>SpringBoot项目会自动创建一个启动器，名字一般是<code>XXXApplication</code>。启动器源码如下，通过<code>SpringApplication</code>构造实例，通过<code>RUN()</code>方法启动项目。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class ExampleApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">		SpringApplication.run(ExampleApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-1-SpringApplication-构造器"><a href="#5-1-SpringApplication-构造器" class="headerlink" title="5.1 SpringApplication 构造器"></a>5.1 SpringApplication 构造器</h5><p>SpringApplication 的作用：<br>1、创建一个恰当的ApplicationContext实例（取决于类路径）<br>2、注册 CommandLinePropertySource，将命令行参数公开为Spring属性<br>3、刷新应用程序上下文，加载所有单例bean<br>4、触发全部CommandLineRunner bean</p>
<p>构造器如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public SpringApplication(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources) &#123;</span><br><span class="line">	this.sources = new LinkedHashSet();</span><br><span class="line">	this.bannerMode = Mode.CONSOLE;</span><br><span class="line">	this.logStartupInfo = true;</span><br><span class="line">	this.addCommandLineProperties = true;</span><br><span class="line">	this.addConversionService = true;</span><br><span class="line">	this.headless = true;</span><br><span class="line">	this.registerShutdownHook = true;</span><br><span class="line">	this.additionalProfiles = new HashSet();</span><br><span class="line">	this.isCustomEnvironment = false;</span><br><span class="line">	this.lazyInitialization = false;</span><br><span class="line">	this.resourceLoader = resourceLoader;</span><br><span class="line">	Assert.notNull(primarySources, &quot;PrimarySources must not be null&quot;);</span><br><span class="line">	this.primarySources = new LinkedHashSet(Arrays.asList(primarySources));</span><br><span class="line">	this.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">	this.setInitializers(this.getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">	this.setListeners(this.getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">	this.mainApplicationClass = this.deduceMainApplicationClass();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要是 deduceFromClasspath、getSpringFactoriesInstances、deduceMainApplicationClass 几个方法</p>
<p><strong><em>deduceFromClasspath</em></strong></p>
<p>源码如下，用于推测WEB应用类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">static WebApplicationType deduceFromClasspath() &#123;</span><br><span class="line">	if (ClassUtils.isPresent(&quot;org.springframework.web.reactive.DispatcherHandler&quot;, (ClassLoader)null) &amp;&amp; !ClassUtils.isPresent(&quot;org.springframework.web.servlet.DispatcherServlet&quot;, (ClassLoader)null) &amp;&amp; !ClassUtils.isPresent(&quot;org.glassfish.jersey.servlet.ServletContainer&quot;, (ClassLoader)null)) &#123;</span><br><span class="line">		return REACTIVE;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		String[] var0 = SERVLET_INDICATOR_CLASSES;</span><br><span class="line">		int var1 = var0.length;</span><br><span class="line"></span><br><span class="line">		for(int var2 = 0; var2 &lt; var1; ++var2) &#123;</span><br><span class="line">			String className = var0[var2];</span><br><span class="line">			if (!ClassUtils.isPresent(className, (ClassLoader)null)) &#123;</span><br><span class="line">				return NONE;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		return SERVLET;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">// 用于判断类能否加载，路径是否存在既定类</span><br><span class="line">public static boolean isPresent(String className, @Nullable ClassLoader classLoader) &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		forName(className, classLoader);</span><br><span class="line">		return true;</span><br><span class="line">	&#125; catch (IllegalAccessError var3) &#123;</span><br><span class="line">		throw new IllegalStateException(&quot;Readability mismatch in inheritance hierarchy of class [&quot; + className + &quot;]: &quot; + var3.getMessage(), var3);</span><br><span class="line">	&#125; catch (Throwable var4) &#123;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从源码上看，主要是判断应用类型是否为<code>NONE</code>、<code>SERVLET</code>或者<code>REACTIVE</code>，这三种类型都是<code>WebApplicationType</code>中定义的。含义如下：</p>
<ul>
<li>SERVLET：传统 MVC Web项目</li>
<li>REACTIVE：响应式Web项目(WebFlux)</li>
<li>NONE：非web项目</li>
</ul>
<p><strong><em>getSpringFactoriesInstances</em></strong></p>
<p>源码如下，主要做了几件事：</p>
<ul>
<li><code>loadFactoryNames</code>加载工程名称</li>
<li><code>createSpringFactoriesInstances</code>根据名字、类型创建工厂实例</li>
<li><code>AnnotationAwareOrderComparator.sort(instances)</code> 对工厂实例进行排序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private &lt;T&gt; Collection&lt;T&gt; getSpringFactoriesInstances(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args) &#123;</span><br><span class="line">	ClassLoader classLoader = this.getClassLoader();</span><br><span class="line">	Set&lt;String&gt; names = new LinkedHashSet(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">	List&lt;T&gt; instances = this.createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">	AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">	return instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>deduceMainApplicationClass</em></strong></p>
<p>从当前堆栈跟踪列表中获取main方法所在的类名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">private Class&lt;?&gt; deduceMainApplicationClass() &#123;</span><br><span class="line">	try &#123;</span><br><span class="line">		StackTraceElement[] stackTrace = (new RuntimeException()).getStackTrace();</span><br><span class="line">		StackTraceElement[] var2 = stackTrace;</span><br><span class="line">		int var3 = stackTrace.length;</span><br><span class="line"></span><br><span class="line">		for(int var4 = 0; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">			StackTraceElement stackTraceElement = var2[var4];</span><br><span class="line">			if (&quot;main&quot;.equals(stackTraceElement.getMethodName())) &#123;</span><br><span class="line">				return Class.forName(stackTraceElement.getClassName());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; catch (ClassNotFoundException var6) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-2-SpringApplication-run-方法"><a href="#5-2-SpringApplication-run-方法" class="headerlink" title="5.2 SpringApplication.run() 方法"></a>5.2 SpringApplication.run() 方法</h5><p>该方法源码如下，主要是 <code>prepareEnvironment</code>、<code>createApplicationContext</code>、<code>prepareContext</code>三个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">  public ConfigurableApplicationContext run(String... args) &#123;</span><br><span class="line">//  记录请求执行时间，便于构建日志</span><br><span class="line">      StopWatch stopWatch = new StopWatch();</span><br><span class="line"></span><br><span class="line">      stopWatch.start();</span><br><span class="line"></span><br><span class="line">      ConfigurableApplicationContext context = null;</span><br><span class="line">      Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = new ArrayList();</span><br><span class="line"></span><br><span class="line">// 1. 配置属性</span><br><span class="line">      this.configureHeadlessProperty();</span><br><span class="line"></span><br><span class="line">//  利用loadFactoryNames方法从路径MEAT-INF/spring.factories中找到所有的SpringApplicationRunListener</span><br><span class="line">      SpringApplicationRunListeners listeners = this.getRunListeners(args);</span><br><span class="line"></span><br><span class="line">//  启动监听器</span><br><span class="line">      listeners.starting();</span><br><span class="line"></span><br><span class="line">      Collection exceptionReporters;</span><br><span class="line">      try &#123;</span><br><span class="line">	// 封装参数到ApplicationArguments对象</span><br><span class="line">          ApplicationArguments applicationArguments = new DefaultApplicationArguments(args);</span><br><span class="line">	</span><br><span class="line">	// 触发监听器(调用每个监听器的environmentPrepared()方法)；存在命令行参数就进行配置</span><br><span class="line">          ConfigurableEnvironment environment = this.prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">	</span><br><span class="line">	// 定义 spring.beaninfo.ignore</span><br><span class="line">          this.configureIgnoreBeanInfo(environment);</span><br><span class="line">	// 获取Banner</span><br><span class="line">          Banner printedBanner = this.printBanner(environment);</span><br><span class="line">	</span><br><span class="line">	// 2. 初始化 context</span><br><span class="line">          context = this.createApplicationContext();</span><br><span class="line">	</span><br><span class="line">	// 解析META-INF/spring.factories文件下的几个类</span><br><span class="line">          exceptionReporters = this.getSpringFactoriesInstances(SpringBootExceptionReporter.class, new Class[]&#123;ConfigurableApplicationContext.class&#125;, context);</span><br><span class="line">	</span><br><span class="line">	// 3. 准备上下文</span><br><span class="line">          this.prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">          this.refreshContext(context);</span><br><span class="line">          this.afterRefresh(context, applicationArguments);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">          stopWatch.stop();</span><br><span class="line">	</span><br><span class="line">          if (this.logStartupInfo) &#123;</span><br><span class="line">              (new StartupInfoLogger(this.mainApplicationClass)).logStarted(this.getApplicationLog(), stopWatch);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          listeners.started(context);</span><br><span class="line">          this.callRunners(context, applicationArguments);</span><br><span class="line">      &#125; catch (Throwable var10) &#123;</span><br><span class="line">          this.handleRunFailure(context, var10, exceptionReporters, listeners);</span><br><span class="line">          throw new IllegalStateException(var10);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">          listeners.running(context);</span><br><span class="line">          return context;</span><br><span class="line">      &#125; catch (Throwable var9) &#123;</span><br><span class="line">          this.handleRunFailure(context, var9, exceptionReporters, (SpringApplicationRunListeners)null);</span><br><span class="line">          throw new IllegalStateException(var9);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>configureHeadlessProperty</em></strong></p>
<p>用来设置java.awt.headless 属性是true 还是false, java.awt.headless是J2SE的一种模式用于在缺少显示屏、键盘或者鼠标时的系统配置，很多监控工具如jconsole 需要将该值设置为true</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">private void configureHeadlessProperty() &#123;</span><br><span class="line">    System.setProperty(&quot;java.awt.headless&quot;, System.getProperty(&quot;java.awt.headless&quot;, Boolean.toString(this.headless)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>prepareEnvironment</em></strong></p>
<p>准备环境</p>
<ul>
<li>配置环境</li>
<li>附加命令行参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private ConfigurableEnvironment prepareEnvironment(SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments) &#123;</span><br><span class="line"></span><br><span class="line">    // 获取或创建环境</span><br><span class="line">	ConfigurableEnvironment environment = this.getOrCreateEnvironment();</span><br><span class="line">	</span><br><span class="line">	// 配置环境：配置PropertySources和activeProfiles</span><br><span class="line">	this.configureEnvironment((ConfigurableEnvironment)environment, applicationArguments.getSourceArgs());</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	ConfigurationPropertySources.attach((Environment)environment);</span><br><span class="line">	</span><br><span class="line">	// listeners环境准备</span><br><span class="line">	listeners.environmentPrepared((ConfigurableEnvironment)environment);</span><br><span class="line">	// 将环境绑定到SpringApplication</span><br><span class="line">	this.bindToSpringApplication((ConfigurableEnvironment)environment);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	// environment转换为StandardEnvironment对象</span><br><span class="line">	if (!this.isCustomEnvironment) &#123;</span><br><span class="line">		environment = (new EnvironmentConverter(this.getClassLoader())).convertEnvironmentIfNecessary((ConfigurableEnvironment)environment, this.deduceEnvironmentClass());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    // 配置PropertySources对它自己的递归依赖</span><br><span class="line">	ConfigurationPropertySources.attach((Environment)environment);</span><br><span class="line">	return (ConfigurableEnvironment)environment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected void configureEnvironment(ConfigurableEnvironment environment, String[] args) &#123;</span><br><span class="line">	if (this.addConversionService) &#123;</span><br><span class="line">		ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">		environment.setConversionService((ConfigurableConversionService)conversionService);</span><br><span class="line">	&#125;</span><br><span class="line">	// 将命令行参数公开为Spring属性</span><br><span class="line">	this.configurePropertySources(environment, args);</span><br><span class="line">	// 设置Profiles，命令行存在则启用命令行的配置</span><br><span class="line">	this.configureProfiles(environment, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>createApplicationContext</em></strong></p>
<p>初始化context。通过构造器中初始化的<code>webApplicationType</code>变量来确定项目类型，从而初始化恰当的 context</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">protected ConfigurableApplicationContext createApplicationContext() &#123;</span><br><span class="line">       Class&lt;?&gt; contextClass = this.applicationContextClass;</span><br><span class="line">       if (contextClass == null) &#123;</span><br><span class="line">           try &#123;</span><br><span class="line">			// 判断项目类型</span><br><span class="line">               switch(this.webApplicationType) &#123;</span><br><span class="line">				case SERVLET:</span><br><span class="line">					contextClass = Class.forName(&quot;org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;);</span><br><span class="line">					break;</span><br><span class="line">				case REACTIVE:</span><br><span class="line">					contextClass = Class.forName(&quot;org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;);</span><br><span class="line">					break;</span><br><span class="line">				default:</span><br><span class="line">					contextClass = Class.forName(&quot;org.springframework.context.annotation.AnnotationConfigApplicationContext&quot;);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; catch (ClassNotFoundException var3) &#123;</span><br><span class="line">               throw new IllegalStateException(&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;, var3);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return (ConfigurableApplicationContext)BeanUtils.instantiateClass(contextClass);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong><em>prepareContext</em></strong></p>
<p>准备上下文：</p>
<ul>
<li>设置上下文的environment</li>
<li>将命令行参数转换为bean</li>
<li>打印启动日志</li>
<li>懒加载判断</li>
<li>将bean加载到应用上下文中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">private void prepareContext(ConfigurableApplicationContext context, ConfigurableEnvironment environment, SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner) &#123;</span><br><span class="line">	// 设置上下文的environment，将context的 environment 切换为SpringApplication的 environment</span><br><span class="line">	context.setEnvironment(environment);</span><br><span class="line">	// 应用上下文后处理</span><br><span class="line">	this.postProcessApplicationContext(context);</span><br><span class="line">	// 应用环境初始化</span><br><span class="line">	this.applyInitializers(context);</span><br><span class="line">	</span><br><span class="line">	//  上下文准备</span><br><span class="line">	listeners.contextPrepared(context);</span><br><span class="line">	</span><br><span class="line">	// // 打印启动日志和启动应用的Profile</span><br><span class="line">	if (this.logStartupInfo) &#123;</span><br><span class="line">		this.logStartupInfo(context.getParent() == null);</span><br><span class="line">		this.logStartupProfileInfo(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 获取配置bean工厂</span><br><span class="line">	ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">	// 注册cmd参数</span><br><span class="line">	beanFactory.registerSingleton(&quot;springApplicationArguments&quot;, applicationArguments);</span><br><span class="line">	// 注册 banner</span><br><span class="line">	if (printedBanner != null) &#123;</span><br><span class="line">		beanFactory.registerSingleton(&quot;springBootBanner&quot;, printedBanner);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	if (beanFactory instanceof DefaultListableBeanFactory) &#123;</span><br><span class="line">		((DefaultListableBeanFactory)beanFactory).setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 懒加载</span><br><span class="line">	if (this.lazyInitialization) &#123;</span><br><span class="line">		context.addBeanFactoryPostProcessor(new LazyInitializationBeanFactoryPostProcessor());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Set&lt;Object&gt; sources = this.getAllSources();</span><br><span class="line">	Assert.notEmpty(sources, &quot;Sources must not be empty&quot;);</span><br><span class="line">	</span><br><span class="line">	// 将bean加载到应用上下文中</span><br><span class="line">	this.load(context, sources.toArray(new Object[0]));</span><br><span class="line">	</span><br><span class="line">	// 向上下文中添加ApplicationListener，并广播ApplicationPreparedEvent事件</span><br><span class="line">	listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.cnblogs.com/youzhibing/p/9697825.html" target="_blank" rel="noopener">spring-boot-2.0.3启动源码篇五 - run方法(四)之prepareContext</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: 古城烟雨</p><p>原文链接: <a href="http://zws6672.top/2020/08/17/springboot-2/">http://zws6672.top/2020/08/17/springboot-2/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/javaweb/">javaweb</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/08/17/springboot-3/" class="pre">springboot（三）注解</a><a href="/2020/08/16/leetcode-202008-10-16/" class="next">leetcode-202008-10-16</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-基本配置"><span class="toc-text">1. 基本配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-Banner"><span class="toc-text">1.1 Banner</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-全局配置文件"><span class="toc-text">1.2 全局配置文件</span></a></li></ol></li></ol><li class="toc-item toc-level-3"><a class="toc-link" href="#2-外部配置"><span class="toc-text">2.  外部配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-命令行参数配置"><span class="toc-text">2.1 命令行参数配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-2-常规属性配置"><span class="toc-text">2.2 常规属性配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-类型安全的配置"><span class="toc-text">2.3 类型安全的配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-其它相关配置"><span class="toc-text">3. 其它相关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#3-1-profile"><span class="toc-text">3.1 profile</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-2-日志"><span class="toc-text">3.2 日志</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-核心注解"><span class="toc-text">4. 核心注解</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-SpringBootApplication"><span class="toc-text">4.1 @SpringBootApplication</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-Enable-系列注解"><span class="toc-text">4.2 @Enable* 系列注解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-启动原理"><span class="toc-text">5. 启动原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-1-SpringApplication-构造器"><span class="toc-text">5.1 SpringApplication 构造器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-2-SpringApplication-run-方法"><span class="toc-text">5.2 SpringApplication.run() 方法</span></a></li></ol></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/06/20/swagger2-1/">swagger2 通过OpenAPI文件生成JAVA代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/16/rustInstall/">rust安装与初试</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/interface-specification/">接口对接规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/swagger2/">swagger2的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/OpenAPI3-0/">OpenAPI 3.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/11/springboot-hot/">springboot实现热部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/07/jdk-source-Object/">jdk8 源码 —— Object</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/03/SHA-256/">SHA-256</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/03/jdk-thread-lock/">线程安全与锁优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/fmi-cos/">FMI2.0 ———— 联合仿真</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/devops/" style="font-size: 15px;">devops</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/neo4j/" style="font-size: 15px;">neo4j</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/co-simulation/" style="font-size: 15px;">co-simulation</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/ms/" style="font-size: 15px;">ms</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/javaweb/" style="font-size: 15px;">javaweb</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/soft-skills/" style="font-size: 15px;">soft-skills</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/jdk-source/" style="font-size: 15px;">jdk-source</a> <a href="/tags/jna/" style="font-size: 15px;">jna</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/nk/" style="font-size: 15px;">nk</a> <a href="/tags/rust/" style="font-size: 15px;">rust</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://juejin.im/" title="掘金" target="_blank">掘金</a><ul></ul><a href="https://www.cnblogs.com/" title="博客园" target="_blank">博客园</a><ul></ul><a href="https://www.infoq.cn/" title="info" target="_blank">info</a><ul></ul><a href="https://www.ibm.com/" title="ibm" target="_blank">ibm</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">古城烟雨.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>