<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一些关于技术的碎语"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>SpringBoot 使用 AOP（面向切面编程） | 微言术语</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SpringBoot 使用 AOP（面向切面编程）</h1><a id="logo" href="/.">微言术语</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">SpringBoot 使用 AOP（面向切面编程）</h1><div class="post-meta"><a href="/2021/04/04/springboot-aop/#comments" class="comment-count"></a><p><span class="date">Apr 04, 2021</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>AOP （Aspect Orient Programming）,译为 面向切面编程，AOP 是一种编程思想，是面向对象编程（OOP）的一种补充。</p>
<h1 id="一、基础"><a href="#一、基础" class="headerlink" title="一、基础"></a>一、基础</h1><p>面向切面编程实现了横切关注点的模块化，即多应用对象相同的处理逻辑被抽象为模块。在多个模块中，如果存在重复的代码，我们可以通过将该代码段抽取成特定的方法使用。但是，如果有新的需求，又需要重复增加新的方法。这时，我们可以通过AOP在不修改源码的情况下，为系统的多个组件添加相同的功能。</p>
<ol>
<li>分类</li>
</ol>
<p>AOP可以分为两类：</p>
<ul>
<li>静态 AOP 实现：代理类和被代理的类实现了同样的接口，代理类同时持有被代理类的引用，通过该引用代理类可以调用被代理类的方法</li>
<li>动态 AOP 实现： AOP 框架在运行阶段动态生成代理对象<ul>
<li>JDK 动态代理：利用反射机制生成一个实现代理接口的类，在调用具体方法前调用InvokeHandler来处理；针对实现接口的类生成代理。</li>
<li>CGlib 动态代理：利用ASM（开源的Java字节码编辑库，操作字节码）开源包，将代理对象类的class文件加载进来，通过修改其字节码生成子类来处理；针对类实现代理，不能代理final修饰的类。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>实现</li>
</ol>
<p>AOP 实现的比较：<br><img src="/image/ssm/aop.png" alt="AOP 实现"></p>
<ol start="3">
<li>术语</li>
</ol>
<ul>
<li>连接点（Joinpoint）：程序执行的某个特定位置，如类开始初始化前、类初始化后、类某个方法调用前、调用后、方法抛出异常后。一个类或一段程序代码拥有一些具有边界性质的特定点，这些点中的特定点就称为“连接点”。Spring仅支持方法的连接点，即仅能在方法调用前、方法调用后、方法抛出异常时以及方法调用前后这些程序执行点织入增强</li>
<li>切点（Pointcut）：每个程序都可以拥有多个连接点，而AOP通过切点查询连接点。切点与连接点的关系是一对多的关系。在Spring中，切点通过org.springframework.aop.Pointcut接口进行描述，它使用类和方法作为连接点的查询条件，Spring AOP的规则解析引擎负责切点所设定的查询条件，找到对应的连接点。</li>
<li>增强（Advice）；增强是织入到目标类连接点上的一段程序代码，在Spring中，增强除用于描述一段程序代码外，还拥有另一个和连接点相关的信息，这便是执行点的方位。结合执行点方位信息和切点信息，我们就可以找到特定的连接点</li>
<li>目标对象（Target）：    增强逻辑的织入目标类。如果没有AOP，目标业务类需要自己实现所有逻辑，而在AOP的帮助下，目标业务类只实现那些非横切逻辑的程序逻辑，而性能监视和事务管理等这些横切逻辑则可以使用AOP动态织入到特定的连接点上。</li>
<li>引介（Introduction）：引介是一种特殊的增强，它为类添加一些属性和方法</li>
<li>织入（Weaving）：织入是将增强添加对目标类具体连接点上的过程；织入方式如下：<ul>
<li>编译期织入，这要求使用特殊的Java编译器。</li>
<li>类装载期织入，这要求使用特殊的类装载器。</li>
<li>动态代理织入，在运行期为目标类添加增强生成子类的方式。（Spring采用的方式）</li>
</ul>
</li>
<li>切面（Aspect）：切面由切点和增强（引介）组成，它既包括了横切逻辑的定义，也包括了连接点的定义，Spring AOP就是负责实施切面的框架，它将切面所定义的横切逻辑织入到切面所指定的连接点中。</li>
</ul>
<p>通知（Advice）类型：</p>
<ul>
<li>前置通知（Before advice）：在某连接点（JoinPoint）之前执行的通知，但这个通知不能阻止连接点前的执行</li>
<li>后置通知（After advice）：当某连接点退出的时候执行的通知（不论是正常返回还是异常退出）</li>
<li>返回后通知（After return advice）：在某连接点正常完成后执行的通知，不包括抛出异常的情况</li>
<li>环绕通知（Around advice）：包围一个连接点的通知，类似Web中Servlet规范中的Filter的doFilter方法。可以在方法的调用前后完成自定义的行为，也可以选择不执行</li>
<li>抛出异常后通知（After throwing advice）：在方法抛出异常退出时执行的通知</li>
</ul>
<h1 id="二、JDK-动态代理"><a href="#二、JDK-动态代理" class="headerlink" title="二、JDK 动态代理"></a>二、JDK 动态代理</h1><p>Java动态代理类位于java.lang.reflect包下，是使用InvocationHandler和Proxy实现的。</p>
<ol>
<li>InvocationHandler</li>
</ol>
<p>InvocationHandler接口是proxy代理实例的调用处理程序实现的一个接口，每一个proxy代理实例都有一个关联的调用处理程序；在代理实例调用方法时，方法调用被编码分派到调用处理程序的invoke方法。 相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Object proxy 代理类</span><br><span class="line">// Method method 被代理的方法</span><br><span class="line">// Object[] args 方法的参数数组</span><br><span class="line">public interface InvocationHandler &#123;</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args)</span><br><span class="line">        throws Throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个接口，我们可以实现一个处理器，提供给代理类使用。</p>
<ol start="2">
<li>Proxy</li>
</ol>
<p>Proxy类就是用来创建一个代理对象的类，一般通过 newProxyInstance 方法来生成对应类的代理类。</p>
<p>相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 返回代理类的一个实例，返回后的代理类可以当作被代理类使用(可使用被代理类的在接口中声明过的方法)</span><br><span class="line">// loader：classloader对象，定义了由哪个类加载器对象对生成的代理类进行加载</span><br><span class="line">// interfaces：接口数组，表示为代理对象提供的数组</span><br><span class="line">// h：InvocationHandler对象，表示的是当动态代理对象调用方法的时候会关联到哪一个InvocationHandler对象上，并最终由其调用</span><br><span class="line"></span><br><span class="line">@CallerSensitive</span><br><span class="line">public static Object newProxyInstance(ClassLoader loader,</span><br><span class="line">									  Class&lt;?&gt;[] interfaces,</span><br><span class="line">									  InvocationHandler h)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>实例</li>
</ol>
<p>对应步骤如下：</p>
<ul>
<li>创建一个实现接口InvocationHandler的类，它必须实现invoke方法</li>
<li>创建被代理的类以及接口</li>
<li>通过Proxy的静态方法newProxyInstance(ClassLoaderloader, Class[] interfaces, InvocationHandler h)创建一个代理</li>
<li>通过代理调用方法</li>
</ul>
<p>对应实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/3 23:16</span><br><span class="line"> * @Description JDK 代理模式</span><br><span class="line"> */</span><br><span class="line">public class JdkProxy &#123;</span><br><span class="line">    public static void main (String[] args) &#123;</span><br><span class="line">        Weapon realWeapon = new Gun();</span><br><span class="line">        InvocationHandler handler = new MyInvocationHandler(realWeapon);</span><br><span class="line">        ClassLoader classLoader = realWeapon.getClass().getClassLoader();</span><br><span class="line">        Class[] clazz = realWeapon.getClass().getInterfaces();</span><br><span class="line"></span><br><span class="line">        Weapon weapon = (Weapon) Proxy.newProxyInstance(classLoader, clazz, handler);</span><br><span class="line">        System.out.println(realWeapon);</span><br><span class="line">        System.out.println(weapon);</span><br><span class="line"></span><br><span class="line">        weapon.description();</span><br><span class="line">        weapon.use();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 调用处理器实现类</span><br><span class="line">class MyInvocationHandler implements InvocationHandler &#123;</span><br><span class="line">    private Object weapon;</span><br><span class="line"></span><br><span class="line">    public MyInvocationHandler(Object weapon) &#123;</span><br><span class="line">        this.weapon = weapon;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</span><br><span class="line">        System.out.println(&quot;在调用实际对象前，实现附加功能&quot;);</span><br><span class="line">        Object res = method.invoke(weapon, args);</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;在调用实际对象后，实现附加功能&quot;);</span><br><span class="line">        return res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 动态代理的接口</span><br><span class="line">interface Weapon &#123;</span><br><span class="line">    void use();</span><br><span class="line">    void description();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理的实际对象</span><br><span class="line">class Gun implements Weapon &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void use() &#123;</span><br><span class="line">        System.out.println(&quot;use gun&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void description() &#123;</span><br><span class="line">        System.out.println(&quot;This is a gun&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、CGlib-动态代理"><a href="#三、CGlib-动态代理" class="headerlink" title="三、CGlib 动态代理"></a>三、CGlib 动态代理</h1><ol>
<li>Enhancer</li>
</ol>
<p>我们需要使用setSuperclass方法设置父类(可以是接口或者是自定义类)，相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void setSuperclass(Class superclass) &#123;</span><br><span class="line">	// 当传入的参数为接口。</span><br><span class="line">	// Enhancer允许为非接口类型创建一个Java代理。Enhancer动态创建了给定类型的子类但是拦截了所有的方法。和Proxy不一样的是，不管是接口还是类他都能正常工作。</span><br><span class="line">	if (superclass != null &amp;&amp; superclass.isInterface()) &#123;</span><br><span class="line">		this.setInterfaces(new Class[]&#123;superclass&#125;);</span><br><span class="line">		this.setContextClass(superclass);</span><br><span class="line">	&#125; else if (superclass != null &amp;&amp; superclass.equals(Object.class)) &#123;</span><br><span class="line">		// 当传入的参数为Object类</span><br><span class="line">		this.superclass = null;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		// 当传入的是自定义类</span><br><span class="line">		this.superclass = superclass;</span><br><span class="line">		this.setContextClass(superclass);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过create方法可以创建对应的类，其实是调用另外一个私有的方法createHelper，相关源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//	用于创建类</span><br><span class="line">	public Object create() &#123;</span><br><span class="line">		this.classOnly = false;</span><br><span class="line">		this.argumentTypes = null;</span><br><span class="line">		return this.createHelper();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// </span><br><span class="line">	private Object createHelper() &#123;</span><br><span class="line">		// 验证是否配置回调类型，验证过滤器是否为空</span><br><span class="line">        this.preValidate();</span><br><span class="line"></span><br><span class="line">        Object key = KEY_FACTORY.newInstance(this.superclass != null ? this.superclass.getName() : null, ReflectUtils.getNames(this.interfaces), this.filter == ALL_ZERO ? null : new WeakCacheKey(this.filter), this.callbackTypes, this.useFactory, this.interceptDuringConstruction, this.serialVersionUID);</span><br><span class="line">        this.currentKey = key;</span><br><span class="line">        Object result = super.create(key);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">// 静态代理工厂，用于创建类</span><br><span class="line">private static final Enhancer.EnhancerKey KEY_FACTORY;</span><br><span class="line"></span><br><span class="line">// 提供一个创建类的接口</span><br><span class="line">public interface EnhancerKey &#123;</span><br><span class="line">	// String var1 被代理的类名</span><br><span class="line">	// String[] var2 被代理的接口名</span><br><span class="line">	// WeakCacheKey&lt;CallbackFilter&gt; var3 回调过滤器</span><br><span class="line">	// Type[] var4 过滤器接口</span><br><span class="line">	// boolean var5 使用工厂</span><br><span class="line">	// boolean var6 使用构造器拦截器</span><br><span class="line">	// Long var7 serialVersionUID 序列化ID</span><br><span class="line">	Object newInstance(String var1, String[] var2, WeakCacheKey&lt;CallbackFilter&gt; var3, Type[] var4, boolean var5, boolean var6, Long var7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实例</li>
</ol>
<p>对应实例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/4 14:48</span><br><span class="line"> * @Description CGLIB 动态代理</span><br><span class="line"> */</span><br><span class="line">public class CGlibProxy &#123;</span><br><span class="line">    public static void main (String[] args) &#123;</span><br><span class="line">//  Enhancer是CGLIB的字节码增强器，可以很方便的对类进行拓展</span><br><span class="line">        Enhancer enhancer = new Enhancer();</span><br><span class="line">//	设置被代理的类</span><br><span class="line">        enhancer.setSuperclass(Hello.class);</span><br><span class="line">//        设置过滤器</span><br><span class="line">        enhancer.setCallback(new HelloMethodInterceptor());</span><br><span class="line">//        通过enhancer创建对象</span><br><span class="line">        Hello hello = (Hello) enhancer.create();</span><br><span class="line">        hello.ha();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Hello &#123;</span><br><span class="line">    void ha() &#123;</span><br><span class="line">        System.out.println(&quot;Hello&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class HelloMethodInterceptor implements MethodInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123;</span><br><span class="line">        System.out.println(&quot;调用&quot;+method.getName()+&quot;方法前输出&quot;);</span><br><span class="line">        Object o1 = methodProxy.invokeSuper(o, objects);</span><br><span class="line">        System.out.println(&quot;调用&quot;+method.getName()+&quot;方法后输出&quot;);</span><br><span class="line">        return o1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在CGLIB中，方法的调用并不是通过反射来完成的，而是直接对方法进行调用：FastClass对Class对象进行特别的处理，比如将会用数组保存method的引用，每次调用方法的时候都是通过一个index下标来保持对方法的引用，因此比JDK 动态代理速度快。但是，CGLIB无法代理被final修饰的方法。</p>
<ol start="3">
<li>FastClass机制</li>
</ol>
<p>Cglib动态代理执行代理方法效率之所以比JDK的高是因为Cglib采用了FastClass机制，它的原理简单来说就是：为代理类和被代理类各生成一个Class，这个Class会为代理类或被代理类的方法分配一个index(int类型)。这个index当做一个入参，FastClass就可以直接定位要调用的方法直接进行调用，这样省去了反射调用，所以调用效率比JDK动态代理通过反射调用高。</p>
<h1 id="四、SpringBoot-使用-AOP"><a href="#四、SpringBoot-使用-AOP" class="headerlink" title="四、SpringBoot 使用 AOP"></a>四、SpringBoot 使用 AOP</h1><ol>
<li>AOP标准</li>
</ol>
<p>AOP联盟标准：<br><img src="/image/ssm/aop-gf.png" alt="AOP 规范"></p>
<p>AOP 实现方式有很多种，包括反射、元数据处理、程序处理、拦截器处理等。而Spring AOP的实现使用的是Java语言本身的特性，即Java Proxy代理类、拦截器技术实现。</p>
<p>Springboot使用 aop 可以通过maven引入相应包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--  springboot web 模块 --&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br><span class="line">&lt;!--  aop--&gt;</span><br><span class="line">	&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;</span><br><span class="line">	&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>PCD</li>
</ol>
<p>PCD(pointcut designators )就是SpringAOP的切点表达式。SpringAOP的PCD是完全兼容AspectJ的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">语法格式如下：</span><br><span class="line">	execution(&lt;修饰符模式&gt;? &lt;返回类型模式&gt; &lt;方法名模式&gt;(&lt;参数模式&gt;) &lt;异常模式&gt;?)</span><br><span class="line"></span><br><span class="line">除了返回类型模式、方法名模式和参数模式外，其它项都是可选的。</span><br><span class="line"></span><br><span class="line">-- 所有公有方法的执行</span><br><span class="line">execution(public * *(..))</span><br><span class="line"></span><br><span class="line">-- 设置指定格式开头的方法</span><br><span class="line">execution(* test*(..))</span><br><span class="line"></span><br><span class="line">-- AccountService接口下的所有方法的执行</span><br><span class="line">execution(* com.service.AccountService.*(..))</span><br><span class="line"></span><br><span class="line">-- 匹配com.xyz.service包下的所有类的所有方法（不含子包）</span><br><span class="line">within(com.xyz.service.*)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>aop 实例：拦截控制器</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/4 16:52</span><br><span class="line"> * @Description 控制器切面</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class ControllerAop &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 指定切点</span><br><span class="line">     * 匹配 com.wsz.tool.rabbitmq.controller包及其子包下的所有类的所有方法</span><br><span class="line">     */</span><br><span class="line">//    @Pointcut(&quot;execution(public * com.wsz.tool.rabbitmq.controller..*.*(..))&quot;)</span><br><span class="line">    @Pointcut(&quot;execution(public * com.wsz.tool.rabbitmq.controller.*Controller.*(..))&quot;)</span><br><span class="line">    public void log() &#123;</span><br><span class="line">        System.out.println(&quot;日志输出：&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Before(&quot;log()&quot;)</span><br><span class="line">    public void doBefore(JoinPoint joinPoint) &#123;</span><br><span class="line">        System.out.println(&quot;前置通知&quot;);</span><br><span class="line">//        目标方法的参数信息</span><br><span class="line">        Object[] objects = joinPoint.getArgs();</span><br><span class="line">        Signature signature = joinPoint.getSignature();</span><br><span class="line"></span><br><span class="line">//        代理方法名</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;代理方法名：&quot;+signature.getName());</span><br><span class="line">        System.out.println(&quot;代理类名：&quot;+signature.getDeclaringTypeName());</span><br><span class="line">        signature.getDeclaringType();</span><br><span class="line">        MethodSignature ms = (MethodSignature) signature;</span><br><span class="line">        System.out.println(&quot;参数名：&quot;+ Arrays.toString(ms.getParameterNames()));</span><br><span class="line">        System.out.println(&quot;参数值：&quot;+ Arrays.toString(joinPoint.getArgs()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 接收到请求，记录请求内容</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest req = attributes.getRequest();</span><br><span class="line">        // 记录下请求内容</span><br><span class="line">        System.out.println(&quot;请求URL : &quot; + req.getRequestURL().toString());</span><br><span class="line">        System.out.println(&quot;HTTP_METHOD : &quot; + req.getMethod());</span><br><span class="line">        System.out.println(&quot;IP : &quot; + req.getRemoteAddr());</span><br><span class="line">        System.out.println(&quot;CLASS_METHOD : &quot; + joinPoint.getSignature().getDeclaringTypeName() + &quot;.&quot; + joinPoint.getSignature().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//    后置异常通知</span><br><span class="line">    @AfterThrowing(&quot;log()&quot;)</span><br><span class="line">    public void throwss(JoinPoint jp) &#123;</span><br><span class="line">        System.out.println(&quot;异常&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @After(&quot;log()&quot;)</span><br><span class="line">    public void after (JoinPoint jp) &#123;</span><br><span class="line">        System.out.println(&quot;后置通知&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>aop实例：拦截自定义注解</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/4 20:12</span><br><span class="line"> * @Description 自定义Log注解</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">*注解的作用目标：</span><br><span class="line">*　@Target(ElementType.TYPE)                      // 接口、类、枚举、注解</span><br><span class="line">*　@Target(ElementType.FIELD)                     // 字段、枚举的常量</span><br><span class="line">*　@Target(ElementType.METHOD)                 // 方法</span><br><span class="line">*  @Target(ElementType.PARAMETER)            // 方法参数</span><br><span class="line">*　@Target(ElementType.CONSTRUCTOR)       // 构造函数</span><br><span class="line">*　@Target(ElementType.LOCAL_VARIABLE)   // 局部变量</span><br><span class="line">*　@Target(ElementType.ANNOTATION_TYPE) // 注解</span><br><span class="line">*　@Target(ElementType.PACKAGE)               // 包</span><br><span class="line">*/</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.METHOD)</span><br><span class="line">@Documented</span><br><span class="line">public @interface MyLog &#123;</span><br><span class="line">    String value();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/4 20:20</span><br><span class="line"> * @Description 自定义注解使用</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class TestService &#123;</span><br><span class="line"></span><br><span class="line">    @MyLog(&quot;TestService&quot;)</span><br><span class="line">    public void test() &#123;</span><br><span class="line">        System.out.println(&quot;test&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @author zws</span><br><span class="line"> * @date 2021/4/4 20:13</span><br><span class="line"> * @Description AOP拦截自定义注解</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">public class MyLogAop &#123;</span><br><span class="line">    @Pointcut(&quot;execution(public * com.wsz.tool.rabbitmq.aop.MyLog.*(..))&quot;)</span><br><span class="line">    public void log() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    /**</span><br><span class="line">     * @Pointcut与@Around的区别：@Pointcut与@Around可以使用相同的PCD表达式，@Pointcut定义的可以重复使用，而@Around不可以</span><br><span class="line">     */</span><br><span class="line">	 </span><br><span class="line">    @Around(value = &quot;@annotation(com.wsz.tool.rabbitmq.aop.MyLog)&quot;)</span><br><span class="line">    public void before(JoinPoint point) &#123;</span><br><span class="line">        System.out.println(&quot;MyLogAop前置通知&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>aop实例：日志<br><a href="https://github.com/xkcoding/spring-boot-demo/tree/master/demo-log-aop" target="_blank" rel="noopener">aop切面日志新增json参数打印和高并发场景</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">@Aspect</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class AopLog &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 切入点</span><br><span class="line">     */</span><br><span class="line">    @Pointcut(&quot;execution(public * com.xkcoding.log.aop.controller.*Controller.*(..))&quot;)</span><br><span class="line">    public void log() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 环绕操作</span><br><span class="line">     *</span><br><span class="line">     * @param point 切入点</span><br><span class="line">     * @return 原方法返回值</span><br><span class="line">     * @throws Throwable 异常信息</span><br><span class="line">     */</span><br><span class="line">    @Around(&quot;log()&quot;)</span><br><span class="line">    public Object aroundLog(ProceedingJoinPoint point) throws Throwable &#123;</span><br><span class="line"></span><br><span class="line">        // 开始打印请求日志</span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = Objects.requireNonNull(attributes).getRequest();</span><br><span class="line"></span><br><span class="line">        // 打印请求相关参数</span><br><span class="line">        long startTime = System.currentTimeMillis();</span><br><span class="line">        Object result = point.proceed();</span><br><span class="line">        String header = request.getHeader(&quot;User-Agent&quot;);</span><br><span class="line">        UserAgent userAgent = UserAgent.parseUserAgentString(header);</span><br><span class="line"></span><br><span class="line">        final Log l = Log.builder()</span><br><span class="line">            .threadId(Long.toString(Thread.currentThread().getId()))</span><br><span class="line">            .threadName(Thread.currentThread().getName())</span><br><span class="line">            .ip(getIp(request))</span><br><span class="line">            .url(request.getRequestURL().toString())</span><br><span class="line">            .classMethod(String.format(&quot;%s.%s&quot;, point.getSignature().getDeclaringTypeName(),</span><br><span class="line">                point.getSignature().getName()))</span><br><span class="line">            .httpMethod(request.getMethod())</span><br><span class="line">            .requestParams(getNameAndValue(point))</span><br><span class="line">            .result(result)</span><br><span class="line">            .timeCost(System.currentTimeMillis() - startTime)</span><br><span class="line">            .userAgent(header)</span><br><span class="line">            .browser(userAgent.getBrowser().toString())</span><br><span class="line">            .os(userAgent.getOperatingSystem().toString()).build();</span><br><span class="line"></span><br><span class="line">        log.info(&quot;Request Log Info : &#123;&#125;&quot;, JSONUtil.toJsonStr(l));</span><br><span class="line"></span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  获取方法参数名和参数值</span><br><span class="line">     * @param joinPoint</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    private Map&lt;String, Object&gt; getNameAndValue(ProceedingJoinPoint joinPoint) &#123;</span><br><span class="line"></span><br><span class="line">        final Signature signature = joinPoint.getSignature();</span><br><span class="line">        MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">        final String[] names = methodSignature.getParameterNames();</span><br><span class="line">        final Object[] args = joinPoint.getArgs();</span><br><span class="line"></span><br><span class="line">        if (ArrayUtil.isEmpty(names) || ArrayUtil.isEmpty(args)) &#123;</span><br><span class="line">            return Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line">        if (names.length != args.length) &#123;</span><br><span class="line">            log.warn(&quot;&#123;&#125;方法参数名和参数值数量不一致&quot;, methodSignature.getName());</span><br><span class="line">            return Collections.emptyMap();</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; map = Maps.newHashMap();</span><br><span class="line">        for (int i = 0; i &lt; names.length; i++) &#123;</span><br><span class="line">            map.put(names[i], args[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static final String UNKNOWN = &quot;unknown&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 获取ip地址</span><br><span class="line">     */</span><br><span class="line">    public static String getIp(HttpServletRequest request) &#123;</span><br><span class="line">        String ip = request.getHeader(&quot;x-forwarded-for&quot;);</span><br><span class="line">        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(&quot;Proxy-Client-IP&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(&quot;WL-Proxy-Client-IP&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (ip == null || ip.length() == 0 || UNKNOWN.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getRemoteAddr();</span><br><span class="line">        &#125;</span><br><span class="line">        String comma = &quot;,&quot;;</span><br><span class="line">        String localhost = &quot;127.0.0.1&quot;;</span><br><span class="line">        if (ip.contains(comma)) &#123;</span><br><span class="line">            ip = ip.split(&quot;,&quot;)[0];</span><br><span class="line">        &#125;</span><br><span class="line">        if (localhost.equals(ip)) &#123;</span><br><span class="line">            // 获取本机真正的ip地址</span><br><span class="line">            try &#123;</span><br><span class="line">                ip = InetAddress.getLocalHost().getHostAddress();</span><br><span class="line">            &#125; catch (UnknownHostException e) &#123;</span><br><span class="line">                log.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Data</span><br><span class="line">    @Builder</span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    @AllArgsConstructor</span><br><span class="line">    static class Log &#123;</span><br><span class="line">        // 线程id</span><br><span class="line">        private String threadId;</span><br><span class="line">        // 线程名称</span><br><span class="line">        private String threadName;</span><br><span class="line">        // ip</span><br><span class="line">        private String ip;</span><br><span class="line">        // url</span><br><span class="line">        private String url;</span><br><span class="line">        // http方法 GET POST PUT DELETE PATCH</span><br><span class="line">        private String httpMethod;</span><br><span class="line">        // 类方法</span><br><span class="line">        private String classMethod;</span><br><span class="line">        // 请求参数</span><br><span class="line">        private Object requestParams;</span><br><span class="line">        // 返回参数</span><br><span class="line">        private Object result;</span><br><span class="line">        // 接口耗时</span><br><span class="line">        private Long timeCost;</span><br><span class="line">        // 操作系统</span><br><span class="line">        private String os;</span><br><span class="line">        // 浏览器</span><br><span class="line">        private String browser;</span><br><span class="line">        // user-agent</span><br><span class="line">        private String userAgent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>如下代码，<code>@Transactional</code>有没有生效？</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class OrderService &#123;</span><br><span class="line"> </span><br><span class="line">	private void insert() &#123;</span><br><span class="line">		insertOrder();</span><br><span class="line">	&#125;</span><br><span class="line">	 </span><br><span class="line">	@Transactional</span><br><span class="line">	public void insertOrder() &#123;</span><br><span class="line">		//SQL操作</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有，<code>@Transactional</code>底层基于AOP实现，自身调用是无法生效的。因为在 Spring 的 AOP 代理下，只有目标方法由外部调用，目标方法才由 Spring 生成的代理对象来管理，这会造成自调用问题。insert()是由被代理对象调用的，而它内调的方法insertOrder() 就不会由代理对象调用，也就无法被添加事务。</p>
<h1 id="五、参考文章"><a href="#五、参考文章" class="headerlink" title="五、参考文章"></a>五、参考文章</h1><blockquote>
<p><a href="https://www.cnblogs.com/joy99/p/10941543.html" target="_blank" rel="noopener">Spring AOP——Spring 中面向切面编程</a><br><a href="https://blog.csdn.net/wyl6019/article/details/80136000" target="_blank" rel="noopener">Spring AOP实现原理简介</a></p>
</blockquote>
</div><div class="post-copyright"><blockquote><p>原文作者: 古城烟雨</p><p>原文链接: <a href="http://zws6672.top/2021/04/04/springboot-aop/">http://zws6672.top/2021/04/04/springboot-aop/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/springboot/">springboot</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2021/04/14/jdk-classesFileStruct/" class="pre">深入理解Java虚拟机——类文件结构</a><a href="/2021/03/30/mysql-lock/" class="next">mysql 引擎的行锁与表锁</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、基础"><span class="toc-text">一、基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、JDK-动态代理"><span class="toc-text">二、JDK 动态代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、CGlib-动态代理"><span class="toc-text">三、CGlib 动态代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、SpringBoot-使用-AOP"><span class="toc-text">四、SpringBoot 使用 AOP</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、参考文章"><span class="toc-text">五、参考文章</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/06/20/swagger2-1/">swagger2 通过OpenAPI文件生成JAVA代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/16/rustInstall/">rust安装与初试</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/interface-specification/">接口对接规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/swagger2/">swagger2的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/15/OpenAPI3-0/">OpenAPI 3.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/11/springboot-hot/">springboot实现热部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/07/jdk-source-Object/">jdk8 源码 —— Object</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/03/SHA-256/">SHA-256</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/03/jdk-thread-lock/">线程安全与锁优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/27/fmi-cos/">FMI2.0 ———— 联合仿真</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/devops/" style="font-size: 15px;">devops</a> <a href="/tags/CI/" style="font-size: 15px;">CI</a> <a href="/tags/tool/" style="font-size: 15px;">tool</a> <a href="/tags/neo4j/" style="font-size: 15px;">neo4j</a> <a href="/tags/微信小程序/" style="font-size: 15px;">微信小程序</a> <a href="/tags/oracle/" style="font-size: 15px;">oracle</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/博客搭建/" style="font-size: 15px;">博客搭建</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/co-simulation/" style="font-size: 15px;">co-simulation</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/ms/" style="font-size: 15px;">ms</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/分布式/" style="font-size: 15px;">分布式</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/javaweb/" style="font-size: 15px;">javaweb</a> <a href="/tags/mq/" style="font-size: 15px;">mq</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/springboot/" style="font-size: 15px;">springboot</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/soft-skills/" style="font-size: 15px;">soft-skills</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/elasticsearch/" style="font-size: 15px;">elasticsearch</a> <a href="/tags/Collection/" style="font-size: 15px;">Collection</a> <a href="/tags/jdk/" style="font-size: 15px;">jdk</a> <a href="/tags/jdk-source/" style="font-size: 15px;">jdk-source</a> <a href="/tags/jna/" style="font-size: 15px;">jna</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/nk/" style="font-size: 15px;">nk</a> <a href="/tags/rust/" style="font-size: 15px;">rust</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://juejin.im/" title="掘金" target="_blank">掘金</a><ul></ul><a href="https://www.cnblogs.com/" title="博客园" target="_blank">博客园</a><ul></ul><a href="https://www.infoq.cn/" title="info" target="_blank">info</a><ul></ul><a href="https://www.ibm.com/" title="ibm" target="_blank">ibm</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">古城烟雨.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>