---
title: linux学习指南（三）权限篇
date: 2019-09-18 15:32:45
tags: linux
---

**开卷语**

>*Linux的权限控制不仅仅包括限制文件访问权限，也包括限制系统访问权限。*
 
Linux系统中，拥有口令安全这一套机制来规范用户管理、限制用户行为、保护账号信息。而对于Linux系统中无处不在的文件，通过三种不同的文件存取身份来管理文件，限制用户对文件的操作。一个错误的权限策略，可能导致系统出现漏洞；而一个好的权限策略，可以大大提高系统的安全性。因此，了解、学习、掌握 Linux 系统的权限控制是很重要的。
 
 
### 一、访问权限
Linux是一个多用户的分时系统，支持多个用户同时登陆使用。通常分配给用户的是普通账号，在实际使用中需要管理员权限时，一般通过【sudo】提升权限。而为了系统的安全性，就需要限制用户的使用期限【口令时效】以及访问环境【默认目录】；也需要通过配置【sudoers 安全策略】来限制用户使用管理员权限。

##### 1. 账号分类

用户在Linux系统中就是一个标识，保存在文件中；一个用户可以从属于多个组，登陆时的组是【主组】，可切换的其它组是【附属组】。

+ 用户账号
	+ 普通用户
	+ 管理员用户（默认root）
+ 账号组
	+ 标准组（多个）
	+ 私有组（个人）


##### 2. 口令安全机制  
  

> 几乎所有的类Unix操作系统的口令文件的格式都雷同，Linux亦不例外。口令安全是Linux操作系统的传统安全问题之一。 Linux使用不可逆的加密算法如DES来加密口令，由于加密算法是不可逆的，所以从密文是得不到明文的。但问题在于，【/etc/passwd】文件是全局可读的，加密的算法是公开的，如果有恶意用户取得了【/etc/passwd】文件，他就可以穷举所有可能的明文通过相同的算法计算出密文进行比较，直到相同，于是他就破解了口令。因此，针对这种安全问题，Linux/Unix广泛采用了“shadow（影子）”机制，将加密的口令转移到【/etc/shadow】文件里，该文件只为root超级用户可读，而同时【/etc/passwd】文件的密文域显示为一个x，从而最大限度减少密文泄露的机会。————影子口令

账号的信息放置在以下的几个文件中:


+ 口令文件
	+ 用户名和 UID 被保存在/etc/passwd文件中，文件权限 (-rw-r--r--)
		```
		用户:密码:uid(用户标识、数字、唯一): gid(组标识、数字、唯一):描述（可为空）:根目录(home):shell(登陆后启动的shell)
		例如：
		【root:x:0:0:root:/root:/bin/bash】 解析如下
			root(用户):x(表示密码加密):0(uid):0(gid):root(描述，可忽略):/root(根目录):/bin/bash(登陆后启动的shell)
		
		```
+ 影子口令文件
	+ 用户口令(密码)被保存在 /etc/shadow文件中  ，文件权限(-rw-r--r-- )
	```
	时间字段：一般是从1970年1月一日起，用数字存储。
	
	【root:$6$7DJRle:18142:0:99999:7:::】 解析如下
		root(用户):$6$7DJRle(密文):18142(最后一次修改时间):0(最小时间间隔):99999(最大时间间隔):7(到密码过期前几天警告):(密码过期后几天禁用账号):(禁用天数):(保留位)
	```
+ 组账号文件
	+ 组和GID 被保存在 /etc/group文件中，文件权限(-r--------)
	```
	root(用户):x(密码加密):0(组ID):(组内用户列表，用【,】分隔)
	```

+ 组影子文件
	+ 组口令被保存在 /etc/gshadow文件中 ，文件权限 (-r--------)
	```
	root(组名):(加密口令):(管理员账号):(组内用户列表)
	```

+ 验证文件完整性命令
	```
	pwck(非影子)：验证用户账号文件，认证信息的完整性。
	grpck(影子)：验证组账号文件，认证信息的完整性。
	```

##### 3. 用户管理的指令

*用户管理*

+ useradd
+ usermod
+ userdel

*组管理*

+ groupadd
+ groupmod
+ groupdel

*口令维护(passwd )*
+ passwd [options] [帐户名]
+ options
	+ -d 删除密码
	+ -e 密码失效
	+ -l 锁定密码，无法匹配
	+ -S 查看状态
	+ -u 恢复口令

*口令时效设置*
+ 修改配置文件【/etc/login.defs】
	+ PASS_MAX_DAYS   99999 【强制修改密码的时间间隔】
	+ PASS_MIN_DAYS   0 【再次修改后的时间】
	+ PASS_MIN_LEN    5 【口令最小长度】
	+ PASS_WARN_AGE   7 【设置密码过期前几天警告】

*用户切换*
+ su
	+ su 用户名
	
+ sudo 提升权限
	+ sudo -i 。该命令可以使用普通用户的密码获得伪root权限，会尝试更改使用户的目录到【/root】,从而可以使用【root】账号的预设命令。但是，需要配置sudoers 安全策略。
	+ sudo -u <用户名> <命令>, 该命令会声明使用该命令的是哪个用户，不设置默认是当前用户；可以用于解决提升权限后 touch文件的所属人是【root】的问题。
	
+ sudoers 安全策略
	+ ```
		1. 需要用户配置安全策略 sudoers【/etc/sudoers】，配置大致类似于：
		【用户名    访问主机=(切换的用户身份)       可使用的命令(目录)，逗号分隔】
		【root ALL=(ALL) ALL】
			root 表示用户名
			第一个 ALL 指示允许从任何终端、机器访问 sudo
			第二个 (ALL) 指示 sudo 命令被允许以任何用户身份执行
			第三个 ALL 表示所有命令都可以作为 root 执行。
			
		2. 而sudo的所有操作都会被保存在【/var/log/auth.log 】中。
		
		3. 在【sudo -i】后，普通用户就可以临时拥有管理员权限了，但是这也是很大的系统隐患。所以，需要限制用户主机、切换的用户身份、可使用的命令
	 ```
	+ 建议
		+ 使用【visudo】来编写文件，这个命令会在保存前检查文件的语法，避免错误
		+ 将修改写在/etc/sudoers.d/目录下的文件中，需要在【/etc/sudoers】的最后行添加 
		` #includedir /etc/sudoers.d `。 任何在/etc/sudoers.d/目录下，不以~号结尾的文件和不包含.号的文件，都会被解析成/etc/sudoers的内容。
	+ 修改会话时间
		+ 将 `Defaults env_reset`修改为
		` Defaults env_reset,pwfeedback,timestamp_timeout=60 #单位是分钟，-1为永久`
	 
*其它用户相关命令*

+ id：显示用户当前的uid、gid和用户所属的组列表

+ groups：显示指定用户所属的组列表

+ whoami：显示当前用户的名称

+ w/who：显示登录用户及相关信息

+ newgrp：用于转换用户的当前组到指定的组账号

***


### 二、文件权限
文件权限的划分如下，每个文件对应访问者的不同分为三部分，即文件拥有者、文件组中的用户以及不在文件组中的其他用户	。文件拥有者很好理解，即文件的创建人；用户组是Linux中的一个概念，一个系统中可以有多个用户，而用户属于一个组。【组权限+它本身的权限 = 它所有的权限】


##### 1. 权限基础  

*UGO模型*

Linux 权限基于 UGO 模型进行控制，每个文件或目录基于UGO进行权限管理。

+ owner【U】 - Owner权限仅应用文件或目录的所有者，它们不会影响其他用户的操作。
+ group【G】 - 组权限仅适用于已分配给文件或目录的组，它们不会影响其他用户的操作。
+ other【O】 - “其它用户”权限适用于系统上的所有其他用户。

*文件类型*
文件分两大类，文件以及文件夹。在使用【ll】命令后，我们可以看到类似于【drwxr-xr-x】的字符串，第一个字符就是文件的类型；【-】表示文件，【d】表示文件夹。

*文件权限*
权限又分为三种基本类型，即读、写、执行（Read、Write、Execute; rwx）

+ read - 读取权限是指用户读取文件内容的功能。
+ write - 写入权限是指用户编写或修改文件或目录的功能。
+ execute - 执行权限会影响用户执行文件或查看目录内容的能力。对文件而言，具有执行文件的权限；对目录了来说该用户具有进入目录的权限。




*修改权限的几个命令*
+ chmod——改变文件或目录的权限

+ chown——改变文件或目录的属主（所有者）

+ chgrp——改变文件或目录所属的组

+ umask——设置文件的缺省生成掩码

##### 2. chmod（更改权限）
chmod 是 【change mode】 的意思，用于改变文件或文件夹的读、写和执行权限。mode描述要修改的权限, 可以用八进制数字或者字母表示，使用字母比较容易理解。


*字母模式*

我们用下面的例子来理解一下，如何识别权限字符串

```
【-】 【rw-】 【r-x】 【-wx】

这一串权限字符串可以分为四部分，
	第一部分是文件类型
	第二部分是拥有者的权限，拥有读写权限；
	第三部分是同组用户权限，拥有读和执行权限；
	第四部分是非同组用户权限，拥有写和执行的权限。
```

*数字模式*

Linux权限也支持使用八进制数字表示，权限也分为三部分，分别用一个八进制数表示。



```

数字表示的权限如下,拥有一个以上的权限则数字相加。
r 4
w 2
x 1

用相同的例子来了解如何使用八进制数字表示权限：
【- rw- r-x -wx】对应的数字是【653】

653：6表示拥有者权限为读写；5表示组权限为读、执行；3表示其它用户权限为写、执行
```


*语法*


用户分类

```
	u：拥有者		 
	g：同一组的用户		
	o：不同组的用户（其他用户）		
	a：所有用户		
```
实例

```
	$ chmod  who[ugoa...][[+-=] permission [rwxX]...][,...]
	[+-=]：添加、取消、设置唯一权限
	
	# 字母
	chmod u+x ex1.py #ex1.py 文件中拥有者添加执行权限
	
	# 数字
	chmod 777 file
```
 

##### 3. Chown（更改所有者）
+ 在Linux系统中，我们通过使用【chown】命令来修改文件的所属人。
+ Chown，将每个给定文件的用户和/或组所有权更改为新的所有者；Chown还可以更改文件的所有权以匹配现有参考文件的用户/组。
注：该命令需要【root】权限
```
chown -options user filename #重设文件的所有者。
chown -options user:group filename #重设文件的所有者以及对应的文件组。
chown -options :group filename #只修改文件对应的文件组
chown -options user: filename # 将所有者及对应的文件组修改到文件
```

*-option的配置*


-c : 显示更改的部分的信息
-f : 忽略错误信息
-h :修复符号链接
-v : 显示详细的处理信息
-R : （递归）处理指定目录以及其子目录下的所有文件
--help : 显示辅助说明
--version : 显示版本
--reference  使用引用FILE的用户和组 



*实例*

```
su root
chown -v root test/
chown -R root test/

chown --reference=b.sh h.sh #表示 【h.sh】配置为【b.sh】的用户和组

```

##### 4. chgrp（Change group ownership/更改群组所有权）

+ chgrp [ Options ] ... { Group | --reference = File } 文件
+ options
	+ -c 显示修改
	+ -f 忽略错误信息
	+ -R 递归修改
	+ -v 显示修改到文件
+ eg ```
chgrp groupname /usr/database
```



##### 5. umask(设置权限掩码)

umask设置一个环境变量，该变量自动为新创建的文件设置文件权限。可以在【/etc/bashrc】或【/etc/profile】中为所有用户设置umask 。默认情况下，大多数Linux发行版将其设置为022或002。

+ ```umask [-p] [-S] [mode]```
+ mode 常用为八进制数字，是权限掩码；如：mode为002时，权限为775.


***
参考文档
> [Java3y: Linux用户和权限管理看了你就会用啦
](https://juejin.im/post/5b1e69dcf265da6e0d7a347e)
[ss64 ———— 操作系统命令参考网站](https://ss64.com/bash/)
[影子口令](https://baike.baidu.com/item/%E5%BD%B1%E5%AD%90%E5%8F%A3%E4%BB%A4/12764636?fr=aladdin)
[码迷：linux详解sudoers](http://www.mamicode.com/info-detail-2376629.html)