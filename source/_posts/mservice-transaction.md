---
title: 微服务中事务的安全性
date: 2020-11-18 23:47:03
tags: [微服务]
---

### 一、基础

1. 什么是事务

事务(TRANSACTION)是作为单个逻辑工作单元执行的一系列操作， 这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行。它的特点可以概况为ACID，具体内容如下：
+	原子性 事务是一个完整的操作
+	一致性 事务内的操作要么一起失败，要么一起成功 
+	隔离性 多个事务是并发操作，不相互影响
+	持久性 修改能永久保存


2. 什么是分布式事务

分布式事务是指事务的操作位于不同的节点上，需要保证事务的 AICD 特性，即保障数据一致性。因为多个微服务不是同一个项目，如果事务中某个节点出现问题，那么这个事务就会出现异常，无法像单机服务一样之间回滚。

本地事务与分布式事务还可以对应为：刚性事务与柔性事务。具体内容如下：
+	刚性事务
	+	遵循ACID原则；具有强一致性；事务可以在同一个物理介质（服务器节点）中完成
+	柔性事务
	+	事务需要在多个介质中完成，此时无法通过ACID保证事务一致性。
	+	伪事务。根据不同的业务使用不同的代码逻辑实现一致性。

3. 微服务的事务中调用远程接口

在微服务中，多个微服务相互调用是很正常的，这样就会形成调用链；而在复杂的业务中，通常会涉及多个表的修改；为了保证事务一致性，会使用事务。所以，微服务肯定会存在一种情况：在事务中调用远程接口。这时会面临两个问题：

+	在事务中调用远程接口查询数据时，如果远程接口出现异常迟迟没有响应，会导致服务无法结束
+	在事务中调用远程接口更新数据时，如果其中一个节点的数据更新失败，那么如何回滚也是一个问题



4. 相关理论

***CAP理论***

CAP原则又称CAP定理，指的是在一个分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。
+	一致性（Consistency）：系列操作都会同时生效
+	可用性（Availability）：每个操作都必须以可预期的响应结束
+	分区容错性（Partition tolerance）：即使出现单个组件无法可用,操作依然可以完成。当网络可靠的时候，提供一致性和可用性将变得十分简单，但当网络不可靠时，同时提供一致性和可用性将变得几乎不可能。然而网络总不是完美可靠的，所以我们不能选择CA。所有实际可用的商用分布式系统至多能提供AP或CP的保证。


***BASE理论***

BASE理论：Basically Available(基本可用)，Soft state（软状态）,和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。

+	基本可用：系统出现严重错误的时候，还是可以提供基本服务
+	软状态：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时
+	最终一致性：在软状态的时间期限过后，所有副本应当保证数据一致性。


***一致性模型***

+	强一致性：数据更新成功后，任意时刻所有副本中的数据都是一致的
+	弱一致性：数据更新成功后，不保证数据即可读到最新写入的值
+	最终一致性：弱一致性的一种形式，系统不承诺立即可以返回最新写入的值，但是保证最终会返回上一次更新操作的值。


###	二、分布式事务解决方案

关于分布式事务，工程领域主要讨论的是强一致性和最终一致性的解决方案。典型解决方案如下：

+	两阶段提交（2PC, Two-phase Commit）方案
+	三阶段提交(3PC)
+	eBay 事件队列方案
+	补偿模式（TCC ）
+	缓存数据最终一致性

1. 两阶段提交——2PC

两阶段提交又称2PC,2PC是一个非常经典的强一致、中心化的原子提交协议。2PC通过中心化来实现数据的强一致性，那什么是中心化呢？中心化是指协议中有两类节点：一个是中心化协调者节点（coordinator）和N个参与者节点（partcipant）。

阶段一：投票阶段

+	事务轮询（预处理请求）
	+	协调者向所有的参与者发送事务预处理请求，称之为Prepare，并开始等待各参与者的响应
+	执行本地事务（执行但不提交）
	+	各个参与者节点执行本地事务操作,但在执行完成后并不会真正提交数据库本地事务
+	各参与者向协调者反馈事务询问的响应（向协调者回馈状态）
	+	事务成功返回YES，否则返回NO

阶段二：提交/执行阶段

+	成功状态（所有参与者节点返回YES）
​	协调者 向 所有参与者 节点发出Commit请求
	参与者 收到Commit请求之后,就会正式执行本地事务Commit操作，然后释放资源
+	异常状态（部分参与者节点返回NO）
​	+	协调者 向所有参与者节点发出 RoollBack 请求
	+	参与者 接收到RoollBack请求后,会回滚本地事务

> 注：在springcloud中，可以搭配 lcn实现两阶段提交。


缺点如下：
+	性能问题
	+	相关服务的数据都被锁住，只有所有节点准备好，协调者才会通知所有节点提交，节点才会释放资源。
+	阻塞问题
	+	协调者宕机。阶段二时，如果协调者发生故障，参与者 会一直阻塞下去，直到启用其它协调者。（解决方案：协调者备份）
	+	参与者宕机。阶段一时，参与者宕机，协调者会陷入阻塞情况。（解决方案：超时机制）
	+	协调者和参与者都宕机
	
2. 三阶段提交(3PC)

三阶段提交协议（3PC）主要是为了解决两阶段提交协议的阻塞问题，2pc存在的问题是当协作者崩溃时，参与者不能做出最后的选择。因此参与者可能在协作者恢复之前保持阻塞。三阶段提交协议在协调者和参与者中都引入超时机制，并且把两阶段提交协议的第一个阶段拆分成了两步：询问，然后再锁资源，最后真正提交。

与2PC的区别：
+	同时在协调者和参与者中都引入超时机制
+	在第一阶段和第二阶段中插入一个准备阶段。保证了在最后提交阶段之前各参与节点的状态是一致的


+	阶段一：询问阶段
	+	协调者向参与者发送commit请求，参与者如果可以提交就返回Yes响应，否则返回No响应。
	
+	阶段二：事务预运行阶段
	+	假如Coordinator从所有的Cohort获得的反馈都是Yes响应，那么就会进行事务的预执行
		+	发送预提交请求(协调者发送PreCommit请求)
		+	事务预提交(参与者执行事务操作)
		+	响应反馈(参与者成功的执行了事务操作，则返回ACK响应，同时开始等待最终指令)
	+	假如参与者的反馈有NO响应或响应超时，则发送中断请求（参与者执行事务的中断）
	
+	阶段三：提交/执行阶段
	+	发送提交请求
		+	事务提交
		+	响应反馈
		+	完成事务
	+	中断事务
	
3. eBay 事件队列方案

核心思想是将需要分布式处理的任务通过消息或者日志的方式来异步执行，消息或日志可以存到本地文件、数据库或消息队列，再通过业务规则进行失败重试，它要求各服务的接口是幂等的。
该方案的核心如下：
+	消费队列
+	BASE理论
+	CAP理论

4. TCC（Try-Confirm-Cancel）补偿模式——最终一致性

某业务模型如图，由服务 A、服务B、服务C、服务D 共同组成的一个微服务架构系统。服务A 需要依次调用服务B、服务C 和服务D 共同完成一个操作。当服务A 调用服务D 失败时，若要保证整个系统数据的一致性，就要对服务B 和服务C 的invoke 操作进行回滚，执行反向的revert 操作。回滚成功后，整个微服务系统是数据一致的。

![TCC](/image/WS/TCC.png)

核心要素：
+	服务调用链必须被记录下来。
+	每个服务提供者都需要提供一组业务逻辑相反的操作，互为补偿，同时回滚操作要保证幂等。
+	必须按失败原因执行不同的回滚策略。

> 幂等：幂等元素是指被自己重复运算(或对于函数是为复合)的结果等于它自己的元素（`s*s=s`）;某一元运算为幂等的时，其作用在任一元素两次后会和其作用一次的结果相同（`f(f(x))=f(x)`）
分布式系统接口幂等性：接口的幂等性实际上就是接口可重复调用，在调用方多次调用的情况下，接口最终得到的结果是一致的;幂等需要通过唯一的业务单号来保证。也就是说相同的业务单号，认为是同一笔业务;防重复提交策略,把查询和变更状态操作加锁，将并行操作改为串行操作。

5. 缓存数据最终一致性

解决方案：
+	为缓存数据设置过期时间。当缓存中数据过期后，业务系统会从数据库中获取数据，并将新值放入缓存。这个过期时间就是系统可以达到最终一致的容忍时间。
+	更新数据库数据后同时清除缓存数据。数据库数据更新后，同步删除缓存中数据，使得下次对商品详情的获取直接从数据库中获取，并同步到缓存。


### 三、参考文章
> [常用的分布式事务解决方案有哪些?](https://www.zhihu.com/question/64921387/answer/225784480)
[译-分布式系统中的一致性模型](https://zhuanlan.zhihu.com/p/48782892)
