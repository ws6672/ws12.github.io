---
title: redis-geo
date: 2020-10-17 15:26:13
tags:
---


### 一、入门

Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，该功能在 Redis 3.2 版本新增。

相关命令
+	geoadd：添加坐标。
+	geopos：获取坐标。
+	geodist：计算坐标间的距离。
+	georadius：根据用户给定的经纬度坐标来获取指定范围内的地理位置集合。
+	georadiusbymember：根据储存在位置集合里面的某个地点获取指定范围内的地理位置集合。
+	geohash：返回一个或多个位置对象的 geohash 值

#### GeoHash
Redis GEO模块使用了GeoHash 算法，可以实现“附近的人”之类的业务。Geohash算法就是将经纬度编码，将二维变一维，给地址位置分区的一种算法。地球上的经度范围就是[-180， 180]，纬度范围就是[-90，90]，以此可以将世界分为四个部分，还可以将每个部分都分成四个部分，那么区域更小、更精确。


***例如***
![geohash](/image/redis/geohash.png)

1.转换(按上图方式转换)
	经度转换结果：`10111000110001111001`
	纬度转换结果：`11010010110001000100`
2.经纬度合并
	经度占偶数位，纬度占奇数位
	`11100 11101 00100 01111 00000 01101 01011 00001`
3.base32转换
	`wx4g0ec1`


#### 相关命令
***GEOADD***

1.`GEOADD key longitude latitude member [longitude latitude member …]`
2. 将给定的空间元素（纬度、经度、名字）添加到指定的键里面。 这些数据会以有序集合的形式被储存在键里面， 从而使得像 GEORADIUS 和 GEORADIUSBYMEMBER 这样的命令可以在之后通过位置查询取得这些元素。
GEOADD 命令以标准的 x,y 格式接受参数， 所以用户必须先输入经度， 然后再输入纬度。 GEOADD 能够记录的坐标是有限的： 非常接近两极的区域是无法被索引的。 精确的坐标限制由 EPSG:900913 / EPSG:3785 / OSGEO:41001 等坐标系统定义， 具体如下：

+	有效的经度介于 -180 度至 180 度之间。
+	有效的纬度介于 -85.05112878 度至 85.05112878 度之间。
3. 返回值：新添加到键里面的空间元素数量， 不包括那些已经存在但是被更新的元素。

***GEOPOS***

1.`GEOPOS key member [member …]`
2. 从键里面返回所有给定位置元素的位置（经度和纬度）。因为 GEOPOS 命令接受可变数量的位置元素作为输入， 所以即使用户只给定了一个位置元素， 命令也会返回数组回复。
3. 返回值：GEOPOS 命令返回一个数组， 数组中的每个项都由两个元素组成： 第一个元素为给定位置元素的经度， 而第二个元素则为给定位置元素的纬度。 当给定的位置元素不存在时， 对应的数组项为空值。

***GEODIST***

1.`GEODIST key member1 member2 [unit]`
2. 返回两个给定位置之间的距离。如果两个位置之间的其中一个不存在， 那么命令返回空值。

指定单位的参数 unit 必须是以下单位的其中一个：

+	m 表示单位为米(默认)
+	km 表示单位为千米
+	mi 表示单位为英里
+	ft 表示单位为英尺

3. 返回值：计算出的距离会以双精度浮点数的形式被返回。 如果给定的位置元素不存在， 那么命令返回空值。

***GEORADIUS***

1.`GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]`
2. 以给定的经纬度为中心， 返回键包含的位置元素当中， 与中心的距离不超过给定最大距离的所有位置元素。
	longitude 经度
	latitude 纬度 
	radius m|km|ft|mi 半径
	WITHDIST：在返回位置元素的同时，将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。
	WITHCOORD：将位置元素的经度和维度也一并返回。
	WITHHASH：以 52 位有符号整数的形式，返回位置元素经过原始 geohash 编码的有序集合分值。这个选项主要用于底层应用或者调试， 实际中的作用并不大。
	ASC|DESC：按从近到远|从远到近的方式返回位置元素
	COUNT：限制返回元素个数

3. 返回值：GEORADIUS 命令返回一个数组

***GEORADIUSBYMEMBER***

1.`GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [ASC|DESC] [COUNT count]`
2. 这个命令和 GEORADIUS 命令一样， 都可以找出位于指定范围内的元素， 但是 GEORADIUSBYMEMBER 的中心点是由给定的位置元素决定的， 而不是像 GEORADIUS 那样， 使用输入的经度和纬度来决定中心点。
3. 返回值：一个数组， 数组中的每个项表示一个范围之内的位置元素。

***GEOHASH***

1.`GEOHASH key member [member …]`
2. 返回一个或多个位置元素的 Geohash 表示。
3. 返回值：一个数组， 数组的每个项都是一个 geohash 。 命令返回的 geohash 的位置与用户给定的位置元素的位置一一对应。

### 二、使用

0. 避免显示中文乱码
```
redis-cli --raw
```

1. 添加测试数据
```
geoadd test 117.68942402507139 39.38156099601735 "天津市天津市宁河县县城" 
geoadd test 117.80726908576221 39.36186975004569 "天津市天津市宁河县芦台镇" 
geoadd test 117.71584605379024 39.4933465148498 "天津市天津市宁河县宁河镇" 
geoadd test 117.8501844708907 39.42779849732088 "天津市天津市宁河县苗庄镇" 
geoadd test 117.78543846525872 39.531225826084246 "天津市天津市宁河县丰台镇" 
geoadd test 117.88141914455765 39.54872385385267 "天津市天津市宁河县岳龙镇"
```

2. 获取地点坐标
```
127.0.0.1:6379> geopos test "天津市天津市宁河县县城"
1) 1) "117.68942266702651978"
   2) "39.38156089934552284"
```

3. 获取两个地点的距离
```
127.0.0.1:6379> GEODIST test "天津市天津市宁河县芦台镇" "天津市天津市宁河县丰台镇" km
"18.9301"
```

4. 获取半径内最近的地点

```
127.0.0.1:6379> georadiusbymember test "天津市天津市宁河县县城" 13 km
天津市天津市宁河县县城
天津市天津市宁河县宁河镇
天津市天津市宁河县芦台镇
```

5. 获取GEOHASH算法转换结果
```
127.0.0.1:6379> GEOHASH test "天津市天津市宁河县县城"
wx58n14y4r0
```

### 三、参考文章

> [Redis GEORADIUS 命令 ](https://www.redis.net.cn/order/3689.html)
[Geohash算法原理及实现](https://www.jianshu.com/p/2fd0cf12e5ba)

